!function(){var a=function(){"use strict";var a,b=function(a){{var b,c="";_.escape,Array.prototype.join}return c+='<p id="rst_pager" class="rst-pager">',a.prev.isFirstPage||(c+='<a class="pager_item rst-pager-item flip glyph-caret-left" data-page="'+(null==(b=a.prev.page)?"":b)+'"></a>'),_.each(a.paginations,function(d){c+=d===a.currentPage?'<span class="pager_item rst-pager-item current">'+(null==(b=d)?"":b)+"</span>":'<a class="pager_item rst-pager-item" data-page="'+(null==(b=d)?"":b)+'">'+(null==(b=d)?"":b)+"</a>"}),a.next.isLastPage||(c+='<a class="pager_item rst-pager-item flip glyph-caret-right" data-page="'+(null==(b=a.next.page)?"":b)+'"></a>'),c+="</p>"};return a=b}(),b=function(){"use strict";function a(a){this.values=a||{},this.events={},this.init()}var b,c=Eleme.Common.Evt,d=Eleme.Common.Http;return $.extend(a.prototype,c),a.prototype.init=function(){this.setDefaults()},a.prototype.setDefaults=function(){_.defaults(this.values,{favored:!1,distance:"",deliver_amount:0})},a.prototype.favor=function(){this.sync("favor",{}).then($.proxy(this.favorHandler,this))},a.prototype.unFavor=function(){this.sync("unfavor",{}).then($.proxy(this.unFavorHandler,this))},a.prototype.favorHandler=function(a){a.success&&(this.values.favored=!0,this.trigger("favorStateChange"))},a.prototype.unFavorHandler=function(a){a.success&&(this.values.favored=!1,this.trigger("favorStateChange"))},a.prototype.sync=function(a,b){var c,e,f=b||{},g={favor:{url:"/favor",type:"post"},unfavor:{url:"/unfavor",type:"post"}};return e=g[a].type,c="//"+window.location.host+ELEME.baseUrl+"/"+ELEME.restaurantUrl+g[a].url,d.request({type:e,url:c,data:f})},b=a}(),c=function(){"use strict";var a,b=function(a){{var b="",c=_.escape;Array.prototype.join}return b+='<p class="rst-rating-dish">',b+=a.isFoodValid?'<a class="link" href="'+c("//"+window.location.host+ELEME.baseUrl+"/"+ELEME.restaurantUrl+"#food/"+a.foodId)+'">'+c(a.foodName)+'<span class="price symbol-rmb">'+c(a.foodPrice)+"</span></a>":'<span class="none">'+c(a.foodName)+"（已下架）</span>",b+='<i class="icon-d-star s'+c(2*a.rating)+'"></i></p><p class="rst-rating-text">'+c(a.ratingText)+'</p><p class="rst-rating-info"><span class="username">'+c(a.username)+"</span>"+c(a.ratedAt)+"</p>"};return a=b}(),d=function(a){"use strict";function b(a){this.id=null,this.model=a,this.init()}function c(a){a=a||{},this.container=a.container,this.hasRender=a.hasRender,this.content=a.content||[],this.childViews=[],this.events={},this.init()}var d={},e=a,f=Eleme.Common.Evt,g=Eleme.Common.RenderBuffer,h={placeHolderSelector:"#fixed_placeholder",emptyTipTpl:'<p id="msg_empty_tip">没有更多留言</p>',aliasClassName:".rst_rating_wrap"};return b.prototype.type="view",b.prototype.tagName="div",b.prototype.className="rst-block rst-rating-block",b.prototype.init=function(){this.id=this.type+"_"+Eleme.View.uuid++,Eleme.View.views[this.id]=this},b.prototype.$el=function(){return $("#"+this.id)},b.prototype.setupContent=function(a){this.model=a},b.prototype.render=function(a){a.begin(this.tagName),a.setId(this.id),a.setClass(this.className),a.pushOpenTag(),a.push(e(this.model)),a.pushCloseTag()},b.prototype.destroy=function(){this.detachDom()},b.prototype.detachDom=function(){this.$el().off()},$.extend(c.prototype,f),c.prototype.tagName="section",c.prototype.className="rst-rating-column",c.prototype.type="view",c.prototype.init=function(){this.id=this.type+"_"+Eleme.View.uuid++,this.on("change",$.proxy(this.contentChange,this))},c.prototype.$el=function(){return $("#"+this.id)},c.prototype.setupContent=function(a){var b=this.content.length;$.isArray(a)&&(this.content=a,this.trigger("change",b))},c.prototype.contentChange=function(){var a=new g;this.hasRender?this.rerender(a):(this.addChildView(),this.render(a))},c.prototype.addChildView=function(){var a=this.childViews;_.each(this.content,function(c){var d=new b(c);a.push(d)})},c.prototype.render=function(a){a.begin(this.tagName),a.setId(this.id),a.setClass(this.className),a.pushOpenTag(),this.renderChildViews(a),a.pushCloseTag(),this.hasRender?this.replaceElement(a):(this.appendToDom(a),this.hasRender=!0)},c.prototype.renderChildViews=function(a){0===this.content.length&&this.renderEmptyTip(a),this.invokeIncursive(function(b){b.render(a)})},c.prototype.renderEmptyTip=function(a){a.push(h.emptyTipTpl)},c.prototype.destroy=function(){this.invokeIncursive(function(a){a.destroy()})},c.prototype.rerender=function(a){this.removeChildViews(),this.addChildView(),this.render(a)},c.prototype.removeChildViews=function(){this.destroy(),this.childViews=[]},c.prototype.invokeIncursive=function(a){_.each(this.childViews,function(b){a(b)})},c.prototype.replaceElement=function(a){var b=this.$el();0===b.length&&(b=$(h.aliasClassName)),b.replaceWith(a.buffer),this.scrollToTop()},c.prototype.appendToDom=function(a){$(this.container).append(a.buffer)},c.prototype.scrollToTop=function(){var a=$(h.placeHolderSelector).offset();$("html, body").animate({scrollTop:a.top+"px"})},d.RatingCollectionView=c,d.RatingView=b,d}(c),e=function(a,b,c){"use strict";function d(){this.$el=null,this.ratingCollectionView=null,this.ratingPage=1,this.init()}var e,f=a,g=c.RatingCollectionView,h=Eleme.Common.Http,i=Eleme.Common.PubSub,j={ratingWrapSelector:"#rating_wrap",pagerWrapSelector:"#rst_pager",paginationSelector:".pager_item",subNavSelector:"#sub_nav",ratingDoneTopic:"ratingDone",ratingErrorTopic:"ratingError",ratingUrl:window.location.pathname};return d.prototype.init=function(){this.$el=$(j.ratingWrapSelector),this.bindEvents(),this.subscribeTopic()},d.prototype.bindEvents=function(){if(this.$el.on("click","a"+j.paginationSelector,$.proxy(this.fetchByPage,this)),$(j.subNavSelector).length){var a=$(j.subNavSelector),b=a.offset().top;$(window).on("scroll",function(){$(window).scrollTop()>b?a.addClass("ui_fixed"):a.removeClass("ui_fixed")})}},d.prototype.subscribeTopic=function(){i.subscribe(j.ratingDoneTopic,function(a){this.renderRatings(a.ratings),this.renderPagination(a.pages)},this),i.subscribe(j.ratingErrorTopic,function(a){this.showErrorTip(a)},this)},d.prototype.fetch=function(a){h.request({type:"get",url:j.ratingUrl,dataType:"json",data:a}).done(function(a){i.publish(j.ratingDoneTopic,a)}).fail(function(a){i.publish(j.ratingErrorTopic,a)})},d.prototype.renderRatings=function(a){this.ratingCollectionView||(this.ratingCollectionView=new g({container:j.ratingWrapSelector,content:new Array(20),hasRender:!0})),this.ratingCollectionView.setupContent(a)},d.prototype.renderPagination=function(a){a=a||[];var b,c;a.length<=1||(b={paginations:a,currentPage:this.ratingPage},b.prev=this.ratingPage===_.min(a)?{isFirstPage:!0}:{isFirstPage:!1,page:this.ratingPage-1},b.next=this.ratingPage===_.max(a)?{isLastPage:!0}:{isLastPage:!1,page:this.ratingPage+1},c=f(b),this.$el.find(j.pagerWrapSelector).remove(),this.$el.append(c))},d.prototype.showErrorTip=function(){},d.prototype.fetchByPage=function(a){a.preventDefault(),this.ratingPage=$(a.target).data("page"),this.fetch({page:this.ratingPage})},e=d}(a,b,d),f=function(){"use strict";var a,b=function(a){var b="",c=_.escape;return b+='<a class="btn-last-page" href="'+c(a.backUrl)+'"><i class="glyph-back"></i>返回</a>'};return a=b}(),g=function(a,b){"use strict";function c(){this.restaurant=new e,this.init()}var d,e=a,f=b,g=Eleme.Common.Evt,h=Eleme.Common.Http,i=Eleme.Common.PubSub,j={headerWrapSelector:".rst_header_con",favorBtnSelector:"#rst_fav",mapSelector:".rst_map",restaurantDeliverAmountSelector:".rst_deliver_amount",restaurantInfoPanelSelector:".rst_info_panel",headDistanceSelector:".rst_head_distance",restaurantDistanceSelector:".rst_distance",restaurantInfoDoneTopic:"restaurantInfoDone",userInfoDoneTopic:"userInfoDone",openLoginPanelTopic:"openLoginPanel",userInfoUrl:"/"+ELEME.restaurantUrl+"/userinfo"};return $.extend(c.prototype,g),c.prototype.init=function(){this.$el=$(j.headerWrapSelector),this.listenTo(this.restaurant,"favorStateChange",$.proxy(this.favorStateHandler,this)),this.bindEvents(),this.subscribeTopic()},c.prototype.bindEvents=function(){var a=this;this.$el.on("click",j.favorBtnSelector,function(){ELEME.authed?a.restaurant.values.favored?a.restaurant.unFavor():a.restaurant.favor():i.publish(j.openLoginPanelTopic)}),this.$el.on("click",j.favorBtnSelector,function(){ga("send","event","restaurant","favorRestaurant")})},c.prototype.subscribeTopic=function(){i.subscribeOnce(j.restaurantInfoDoneTopic,function(a){this.updateRestaurantInfo(a)},this),i.subscribeOnce(j.userInfoDoneTopic,function(a){this.fetchRstInfo(),this.addBackIcon(a.geohash)},this)},c.prototype.fetchRstInfo=function(){var a=ELEME.baseUrl+j.userInfoUrl;h.request({type:"get",url:a,cache:!1}).done(function(a){i.publish(j.restaurantInfoDoneTopic,a)}).fail(function(){})},c.prototype.updateRestaurantInfo=function(a){this.restaurant.values=a,this.restaurant.values.distance?this.$el.find(j.restaurantDistanceSelector).html(this.restaurant.values.distance):this.$el.find(j.headDistanceSelector).addClass("hide"),this.$el.find(j.mapSelector).attr("src",a.mapUrl),this.$el.find(j.restaurantDeliverAmountSelector).html(this.restaurant.values.deliverAmount),this.$el.find(j.restaurantInfoPanelSelector).show(),this.favorStateHandler()},c.prototype.addBackIcon=function(a){var b;b=a?ELEME.isRestaurantPremium?"http://"+ELEME.rootHost+"/premium/geohash/"+a:"http://"+ELEME.rootHost+"/place/"+a:"http://"+ELEME.rootHost,this.$el.prepend(f({backUrl:b}))},c.prototype.favorStateHandler=function(){var a,b=this.$el.find(j.favorBtnSelector),c=b.find("span");this.restaurant.values.favored?(a=c.data("faved"),b.addClass("ui_faved"),c.text(a)):(a=c.data("unfaved"),b.removeClass("ui_faved"),c.text(a))},d=c}(b,f),h=function(){"use strict";function a(){this.$el=null,this.active=!1,this.init()}var b,c=Eleme.Common.PubSub,d={loginModalSelector:"#modal_iLogin",iframeSelector:".login_frame",openLoginPanelTopic:"openLoginPanel"};return a.prototype.init=function(){this.$el=$(d.loginModalSelector),this.bindEvents(),this.subscribeTopic()},a.prototype.bindEvents=function(){this.$el.on("hidden.bs.modal",$.proxy(this.hide,this)),this.$el.on("shown.bs.modal",$.proxy(this.setPage,this)),$(window).on("message.login",$.proxy(this.handleMsg,this))},a.prototype.subscribeTopic=function(){c.subscribe(d.openLoginPanelTopic,function(){this.open()},this)},a.prototype.open=function(){this.$el.modal("show")},a.prototype.hide=function(){this.active=!1},a.prototype.setPage=function(){var a=this.$el.find(d.iframeSelector),b=this.getPageUrl();a.attr("src",b)},a.prototype.getPageUrl=function(){return"https://account."+ELEME.rootHost+ELEME.baseUrl+"/ilogin"},a.prototype.handleMsg=function(a){var b=a.originalEvent.origin,c=a.originalEvent.data;b==="https://account."+ELEME.rootHost&&"string"==typeof c&&(c=JSON.parse(c),c.success&&this.handleSuccess())},a.prototype.handleSuccess=function(){window.location.reload(!0)},b=a}();!function(a,b,c){"use strict";var d=a,e=b,f=c;Eleme.View={views:{},uuid:0},_.templateSettings.variable="data";new d,new e,new f}(e,g,h)}();