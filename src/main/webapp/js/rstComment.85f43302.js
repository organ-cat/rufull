!function(){var a=function(){"use strict";var a,b=function(a){{var b,c="";_.escape,Array.prototype.join}return c+='<p id="rst_pager" class="rst-pager">',a.prev.isFirstPage||(c+='<a class="pager_item rst-pager-item flip glyph-caret-left" data-page="'+(null==(b=a.prev.page)?"":b)+'"></a>'),_.each(a.paginations,function(d){c+=d===a.currentPage?'<span class="pager_item rst-pager-item current">'+(null==(b=d)?"":b)+"</span>":'<a class="pager_item rst-pager-item" data-page="'+(null==(b=d)?"":b)+'">'+(null==(b=d)?"":b)+"</a>"}),a.next.isLastPage||(c+='<a class="pager_item rst-pager-item flip glyph-caret-right" data-page="'+(null==(b=a.next.page)?"":b)+'"></a>'),c+="</p>"};return a=b}(),b=function(){"use strict";var a,b=function(a){{var b="",c=_.escape;Array.prototype.join}return b+='<div class="rst-comment group"><img class="user-avatar" src="'+c(a.comment.avatar)+'" alt="'+c(a.comment.username)+'" /><div class="user-comment"><p class="rst-comment-info"><span class="name">'+c(a.comment.username)+"</span>"+c(a.comment.createdAt)+'</p><p class="rst-comment-content">'+c(a.comment.content)+"</p></div></div>",a.replies&&a.replies.length>0&&(b+='<div class="rst-reply-wrapper">',_.each(a.replies,function(a){b+='<div class="rst-reply group"><img class="manager-avatar" src="'+c(a.rstLogo)+'" alt="'+c(a.rstName)+'" /><div class="manager-comment"><p class="rst-comment-info"><span class="name">餐厅回复</span>'+c(a.createdAt)+'</p><p class="rst-comment-content">'+c(a.content)+"</p></div></div>"}),b+="</div>"),b};return a=b}(),c=function(a){"use strict";function b(a){this.id=null,this.model=a,this.init()}function c(a){this.content=a.content||[],this.container=a.container,this.hasRender=a.hasRender,this.childViews=[],this.events={},this.init()}var d={},e=a,f=Eleme.Common.Evt,g=Eleme.Common.RenderBuffer,h={placeHolderSelector:"#fixed_placeholder",emptyTipTpl:'<p id="msg_empty_tip">没有更多留言</p>',aliasClassName:".rst_msg_wrap"};return b.prototype.type="view",b.prototype.className="rst-comment-wrapper",b.prototype.tagName="div",b.prototype.init=function(){this.id=this.type+"_"+Eleme.View.uuid++,Eleme.View.views[this.id]=this},b.prototype.$el=function(){return $("#"+this.id)},b.prototype.setupContent=function(a){this.model=a},b.prototype.render=function(a){a.begin(this.tagName),a.setId(this.id),a.setClass(this.className),a.pushOpenTag(),a.push(e(this.model)),a.pushCloseTag()},b.prototype.destroy=function(){this.detachDom()},b.prototype.detachDom=function(){this.$el().off()},$.extend(c.prototype,f),c.prototype.tagName="section",c.prototype.type="view",c.prototype.className="rst_msg_wrap",c.prototype.init=function(){this.id=this.type+"_"+Eleme.View.uuid++,this.on("change",$.proxy(this.contentChange,this)),Eleme.View.views[this.id]=this},c.prototype.$el=function(){return $("#"+this.id)},c.prototype.setupContent=function(a){var b=this.content.length;$.isArray(a)&&(this.content=a,this.trigger("change",b))},c.prototype.contentChange=function(a){var b=new g;0!==a?this.hasRender?this.rerender(b):(this.addChildView(),this.render(b)):(this.addChildView(),this.appendChildViews(b))},c.prototype.appendChildViews=function(a){var b=this.$el();0===b.length&&(b=$(h.aliasClassName)),this.invokeIncursive(function(b){b.render(a)}),b.prepend(a.buffer)},c.prototype.addChildView=function(){var a=this.childViews;_.each(this.content,function(c){var d=new b(c);a.push(d)})},c.prototype.render=function(a){a.begin(this.tagName),a.setId(this.id),a.setClass(this.className),a.pushOpenTag(),this.renderChildViews(a),a.pushCloseTag(),this.hasRender?this.replaceElement(a):(this.appendToDom(a),this.hasRender=!0)},c.prototype.renderChildViews=function(a){0===this.content.length&&this.renderEmptyTip(a),this.invokeIncursive(function(b){b.render(a)})},c.prototype.renderEmptyTip=function(a){a.push(h.emptyTipTpl)},c.prototype.destroy=function(){this.invokeIncursive(function(a){a.destroy()})},c.prototype.rerender=function(a){this.removeChildViews(),this.addChildView(),this.render(a)},c.prototype.removeChildViews=function(){this.destroy(),this.childViews=[]},c.prototype.invokeIncursive=function(a){_.each(this.childViews,function(b){a(b)})},c.prototype.replaceElement=function(a){var b=this.$el();0===b.length&&(b=$(h.aliasClassName)),b.replaceWith(a.buffer),this.scrollToTop()},c.prototype.appendToDom=function(a){$(this.container).append(a.buffer)},c.prototype.scrollToTop=function(){var a=$(h.placeHolderSelector).offset();$("html, body").animate({scrollTop:a.top+"px"})},d.MessageCollectionView=c,d.MessageView=b,d}(b),d=function(a,b){"use strict";function c(){this.$el=null,this.messageCollectionView=null,this.init(),this.msgPage=1}var d,e=a,f=b.MessageView,g=b.MessageCollectionView,h=Eleme.Common.Http,i=Eleme.Common.PubSub,j=Eleme.Common.RenderBuffer,k={msgFormSelector:".msg_form",captchaImgSelector:"#captcha_img",captchaInputSelector:"#captcha_input",msgTextareaSelector:"#msg_textarea",errTipSelector:".err_tip",msgModalSelector:"#modal_comment",emptyMsgSelector:"#rst_empty_tip",cmtWrapSelector:"#rst_cmt",pagerWrapSelector:"#rst_pager",pagenationSelector:".pager_item",subNavSelector:"#sub_nav",msgWrapSelector:".rst_msg_wrap",restaurantDeliverAmountSelector:".rst_deliver_amount",messageDoneTopic:"messageDone",messageErrorTopic:"messageError",restaurantInfoDoneTopic:"restaurantInfoDone",captchaUrl:"/captcha",fetchMessageUrl:window.location.pathname};return c.prototype.init=function(){this.$el=$(k.cmtWrapSelector),this.messageCollectionView=new g({container:k.cmtWrapSelector,content:new Array(20),hasRender:!0}),this.bindEvents(),this.subscribeTopic(),this.checkMessage()},c.prototype.bindEvents=function(){if(this.$el.on("submit",k.msgFormSelector,$.proxy(this.addMessage,this)),this.$el.on("click",k.captchaImgSelector,$.proxy(this.freshCAPTCHA,this)),this.$el.on("click","a"+k.pagenationSelector,$.proxy(this.fetchByPage,this)),$(k.msgTextareaSelector).on("keyup",function(){if($(this).val()){var a=$(this).closest("form").find(".btn-disabled");a.removeClass("btn-disabled").removeAttr("disabled")}}),$(k.captchaInputSelector).on("keyup",function(){if($(k.msgTextareaSelector).val()&&$(this).val()){var a=$(this).closest("form").find(".btn-disabled");a.removeClass("btn-disabled").removeAttr("disabled")}}),$(k.subNavSelector).length){var a=$(k.subNavSelector),b=a.offset().top;$(window).on("scroll",function(){$(window).scrollTop()>b?a.addClass("ui_fixed"):a.removeClass("ui_fixed")})}},c.prototype.subscribeTopic=function(){i.subscribe(k.restaurantInfoDoneTopic,function(a){$(k.restaurantDeliverAmountSelector).text(a.deliverAmount)},this),i.subscribe(k.messageDoneTopic,function(a){this.renderMessage(a),this.renderPagination(a.pages)},this),i.subscribe(k.messageErrorTopic,function(a){this.showErrorTip(a.errorMsg)},this)},c.prototype.fetch=function(a){h.request({type:"get",url:k.fetchMessageUrl,dataType:"json",data:a}).done(function(a){i.publish(k.messageDoneTopic,a)}).fail(function(a){i.publish(k.messageErrorTopic,a)})},c.prototype.fetchByPage=function(a){a.preventDefault(),this.msgPage=$(a.target).data("page"),this.fetch({page:this.msgPage})},c.prototype.renderMessage=function(a){var b=a.restaurantName,c=a.restaurantLogoUrl,d=a.commentWithReplies||[];_.each(d,function(a){a.replies&&a.replies.length>0&&_.each(a.replies,function(a){a.rstLogo=c,a.rstName=b})}),this.messageCollectionView.setupContent(d)},c.prototype.renderPagination=function(a){a=a||[];var b,c;a.length<=1||(b={paginations:a,currentPage:this.msgPage},b.prev=a.length<=5&&this.msgPage===_.min(a)?{isFirstPage:!0}:{isFirstPage:!1,page:this.msgPage-1},b.next=a.length<=5&&this.msgPage===_.max(a)?{isLastPage:!0}:{isLastPage:!1,page:this.msgPage+1},c=e(b),this.$el.find(k.pagerWrapSelector).remove(),this.$el.find(k.msgWrapSelector).after(c))},c.prototype.showErrorTip=function(a){this.$el.find(k.cmtWrapSelector).append('<div id="msg_err_tip">'+a+"</div>")},c.prototype.checkMessage=function(){{var a=(this.$el.find(k.msgTextareaSelector),this.$el.find(k.msgModalSelector)),b=$(".msg_id").text();window.location.pathname}b&&a.modal("show")},c.prototype.addMessage=function(a){function b(a){a.removeAttr("disabled").removeClass("btn-disabled")}var c,d,e=this,f=[$(a.target).find(".msg_id").text(),$(a.target).find(".msg_detail").text()];f=f[0]?f.concat(" ").join("，"):"";var g=this.$el.find(k.msgTextareaSelector).val(),i=(/我的饿单麻烦快一点/.test(g)?"【催单】":"")+f+g,j=this.$el.find(k.captchaInputSelector).val(),l=$(a.target).find(".btn-confirm");return c=window.location.href.replace("/mine",""),a.preventDefault(),l.attr("disabled","disabled"),l.addClass("btn-disabled"),d=this.validateMsgForm(j,i),d.valid?void h.request({type:"post",url:c,data:{captcha:j,content:i}}).done(function(a){e.$el.find(k.msgModalSelector).modal("hide").find(k.errTipSelector).html("").addClass("hide"),e.$el.find(k.msgTextareaSelector).val(""),e.$el.find(k.captchaInputSelector).val(""),b(l),e.freshCAPTCHA(),e.appendMessage(a)}).fail(function(a){e.msgErrorHandler(a.msg),b(l),e.freshCAPTCHA(),e.$el.find(k.captchaInputSelector).focus()}):void this.msgErrorHandler(d.errTip)},c.prototype.validateMsgForm=function(a,b){return"undefined"==typeof b||""===b?{valid:!1,errTip:"您还没有填写留言"}:"undefined"==typeof a||""===a?{valid:!1,errTip:"请填写验证码"}:{valid:!0}},c.prototype.msgErrorHandler=function(a){this.$el.find(k.errTipSelector).html(a).removeClass("hide")},c.prototype.freshCAPTCHA=function(){var a="//"+ELEME.mainHost+k.captchaUrl;a+="?action=comment",a+="&t="+(new Date).getTime(),this.$el.find(k.captchaImgSelector).attr("src",a)},c.prototype.appendMessage=function(a){var b={comment:a,replies:[]},c=new f(b),d=new j;c.render(d),this.$el.find(k.msgWrapSelector).prepend($(d.buffer)),d=null},d=c}(a,c),e=function(){"use strict";function a(a){this.values=a||{},this.events={},this.init()}var b,c=Eleme.Common.Evt,d=Eleme.Common.Http;return $.extend(a.prototype,c),a.prototype.init=function(){this.setDefaults()},a.prototype.setDefaults=function(){_.defaults(this.values,{favored:!1,distance:"",deliver_amount:0})},a.prototype.favor=function(){this.sync("favor",{}).then($.proxy(this.favorHandler,this))},a.prototype.unFavor=function(){this.sync("unfavor",{}).then($.proxy(this.unFavorHandler,this))},a.prototype.favorHandler=function(a){a.success&&(this.values.favored=!0,this.trigger("favorStateChange"))},a.prototype.unFavorHandler=function(a){a.success&&(this.values.favored=!1,this.trigger("favorStateChange"))},a.prototype.sync=function(a,b){var c,e,f=b||{},g={favor:{url:"/favor",type:"post"},unfavor:{url:"/unfavor",type:"post"}};return e=g[a].type,c="//"+window.location.host+ELEME.baseUrl+"/"+ELEME.restaurantUrl+g[a].url,d.request({type:e,url:c,data:f})},b=a}(),f=function(){"use strict";var a,b=function(a){var b="",c=_.escape;return b+='<a class="btn-last-page" href="'+c(a.backUrl)+'"><i class="glyph-back"></i>返回</a>'};return a=b}(),g=function(a,b){"use strict";function c(){this.restaurant=new e,this.init()}var d,e=a,f=b,g=Eleme.Common.Evt,h=Eleme.Common.Http,i=Eleme.Common.PubSub,j={headerWrapSelector:".rst_header_con",favorBtnSelector:"#rst_fav",mapSelector:".rst_map",restaurantDeliverAmountSelector:".rst_deliver_amount",restaurantInfoPanelSelector:".rst_info_panel",headDistanceSelector:".rst_head_distance",restaurantDistanceSelector:".rst_distance",restaurantInfoDoneTopic:"restaurantInfoDone",userInfoDoneTopic:"userInfoDone",openLoginPanelTopic:"openLoginPanel",userInfoUrl:"/"+ELEME.restaurantUrl+"/userinfo"};return $.extend(c.prototype,g),c.prototype.init=function(){this.$el=$(j.headerWrapSelector),this.listenTo(this.restaurant,"favorStateChange",$.proxy(this.favorStateHandler,this)),this.bindEvents(),this.subscribeTopic()},c.prototype.bindEvents=function(){var a=this;this.$el.on("click",j.favorBtnSelector,function(){ELEME.authed?a.restaurant.values.favored?a.restaurant.unFavor():a.restaurant.favor():i.publish(j.openLoginPanelTopic)}),this.$el.on("click",j.favorBtnSelector,function(){ga("send","event","restaurant","favorRestaurant")})},c.prototype.subscribeTopic=function(){i.subscribeOnce(j.restaurantInfoDoneTopic,function(a){this.updateRestaurantInfo(a)},this),i.subscribeOnce(j.userInfoDoneTopic,function(a){this.fetchRstInfo(),this.addBackIcon(a.geohash)},this)},c.prototype.fetchRstInfo=function(){var a=ELEME.baseUrl+j.userInfoUrl;h.request({type:"get",url:a,cache:!1}).done(function(a){i.publish(j.restaurantInfoDoneTopic,a)}).fail(function(){})},c.prototype.updateRestaurantInfo=function(a){this.restaurant.values=a,this.restaurant.values.distance?this.$el.find(j.restaurantDistanceSelector).html(this.restaurant.values.distance):this.$el.find(j.headDistanceSelector).addClass("hide"),this.$el.find(j.mapSelector).attr("src",a.mapUrl),this.$el.find(j.restaurantDeliverAmountSelector).html(this.restaurant.values.deliverAmount),this.$el.find(j.restaurantInfoPanelSelector).show(),this.favorStateHandler()},c.prototype.addBackIcon=function(a){var b;b=a?ELEME.isRestaurantPremium?"http://"+ELEME.rootHost+"/premium/geohash/"+a:"http://"+ELEME.rootHost+"/place/"+a:"http://"+ELEME.rootHost,this.$el.prepend(f({backUrl:b}))},c.prototype.favorStateHandler=function(){var a,b=this.$el.find(j.favorBtnSelector),c=b.find("span");this.restaurant.values.favored?(a=c.data("faved"),b.addClass("ui_faved"),c.text(a)):(a=c.data("unfaved"),b.removeClass("ui_faved"),c.text(a))},d=c}(e,f),h=function(){"use strict";function a(){this.$el=null,this.active=!1,this.init()}var b,c=Eleme.Common.PubSub,d={loginModalSelector:"#modal_iLogin",iframeSelector:".login_frame",openLoginPanelTopic:"openLoginPanel"};return a.prototype.init=function(){this.$el=$(d.loginModalSelector),this.bindEvents(),this.subscribeTopic()},a.prototype.bindEvents=function(){this.$el.on("hidden.bs.modal",$.proxy(this.hide,this)),this.$el.on("shown.bs.modal",$.proxy(this.setPage,this)),$(window).on("message.login",$.proxy(this.handleMsg,this))},a.prototype.subscribeTopic=function(){c.subscribe(d.openLoginPanelTopic,function(){this.open()},this)},a.prototype.open=function(){this.$el.modal("show")},a.prototype.hide=function(){this.active=!1},a.prototype.setPage=function(){var a=this.$el.find(d.iframeSelector),b=this.getPageUrl();a.attr("src",b)},a.prototype.getPageUrl=function(){return"https://account."+ELEME.rootHost+ELEME.baseUrl+"/ilogin"},a.prototype.handleMsg=function(a){var b=a.originalEvent.origin,c=a.originalEvent.data;b==="https://account."+ELEME.rootHost&&"string"==typeof c&&(c=JSON.parse(c),c.success&&this.handleSuccess())},a.prototype.handleSuccess=function(){window.location.reload(!0)},b=a}();!function(a,b,c){"use strict";var d=a,e=b,f=c;Eleme.View={views:{},uuid:0},_.templateSettings.variable="data";new d,new e,new f}(d,g,h)}();