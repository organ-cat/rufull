!function(){var a=function(){"use strict";function a(){return $('<div class="modal-wrap modal_wrap"><div class="modal-backdrop modal_backdrop"></div></div>')}var b,c={modalWrapSelector:".modal_wrap",modalBackdropSelector:".modal_backdrop",modalContentSelector:".modal_content"},d={showModal:function(b){var c=a();$(document.body).addClass("ui_no_scroll"),c.append(b).appendTo(this.$el)},hideModal:function(){$(document.body).removeClass("ui_no_scroll"),this.$el.find(c.modalWrapSelector).remove()}};return b=d}(),b=function(){"use strict";var a;void 0===Date.now&&(Date.now=function(){return(new Date).valueOf()});var b=b||function(){var a=[];return{REVISION:"13",getAll:function(){return a},removeAll:function(){a=[]},add:function(b){a.push(b)},remove:function(b){b=a.indexOf(b),-1!==b&&a.splice(b,1)},update:function(b){if(0===a.length)return!1;for(var c=0,b=void 0!==b?b:"undefined"!=typeof window&&void 0!==window.performance&&void 0!==window.performance.now?window.performance.now():Date.now();c<a.length;)a[c].update(b)?c++:a.splice(c,1);return!0}}}();return b.Tween=function(a){var c,d={},e={},f={},g=1e3,h=0,i=!1,j=!1,k=0,l=null,m=b.Easing.Linear.None,n=b.Interpolation.Linear,o=[],p=null,q=!1,r=null,s=null,t=null;for(c in a)d[c]=parseFloat(a[c],10);this.to=function(a,b){return void 0!==b&&(g=b),e=a,this},this.start=function(c){b.add(this),j=!0,q=!1,l=void 0!==c?c:"undefined"!=typeof window&&void 0!==window.performance&&void 0!==window.performance.now?window.performance.now():Date.now(),l+=k;for(var g in e){if(e[g]instanceof Array){if(0===e[g].length)continue;e[g]=[a[g]].concat(e[g])}d[g]=a[g],!1==d[g]instanceof Array&&(d[g]*=1),f[g]=d[g]||0}return this},this.stop=function(){return j?(b.remove(this),j=!1,null!==t&&t.call(a),this.stopChainedTweens(),this):this},this.stopChainedTweens=function(){for(var a=0,b=o.length;b>a;a++)o[a].stop()},this.delay=function(a){return k=a,this},this.repeat=function(a){return h=a,this},this.yoyo=function(a){return i=a,this},this.easing=function(a){return m=a,this},this.interpolation=function(a){return n=a,this},this.chain=function(){return o=arguments,this},this.onStart=function(a){return p=a,this},this.onUpdate=function(a){return r=a,this},this.onComplete=function(a){return s=a,this},this.onStop=function(a){return t=a,this},this.update=function(b){var c;if(l>b)return!0;!1===q&&(null!==p&&p.call(a),q=!0);var j=(b-l)/g,j=j>1?1:j,t=m(j);for(c in e){var u=d[c]||0,v=e[c];v instanceof Array?a[c]=n(v,t):("string"==typeof v&&(v=u+parseFloat(v,10)),"number"==typeof v&&(a[c]=u+(v-u)*t))}if(null!==r&&r.call(a,t),1==j){if(!(h>0)){for(null!==s&&s.call(a),c=0,j=o.length;j>c;c++)o[c].start(b);return!1}isFinite(h)&&h--;for(c in f)"string"==typeof e[c]&&(f[c]+=parseFloat(e[c],10)),i&&(j=f[c],f[c]=e[c],e[c]=j),d[c]=f[c];l=b+k}return!0}},b.Easing={Linear:{None:function(a){return a}},Quadratic:{In:function(a){return a*a},Out:function(a){return a*(2-a)},InOut:function(a){return 1>(a*=2)?.5*a*a:-.5*(--a*(a-2)-1)}},Cubic:{In:function(a){return a*a*a},Out:function(a){return--a*a*a+1},InOut:function(a){return 1>(a*=2)?.5*a*a*a:.5*((a-=2)*a*a+2)}},Quartic:{In:function(a){return a*a*a*a},Out:function(a){return 1- --a*a*a*a},InOut:function(a){return 1>(a*=2)?.5*a*a*a*a:-.5*((a-=2)*a*a*a-2)}},Quintic:{In:function(a){return a*a*a*a*a},Out:function(a){return--a*a*a*a*a+1},InOut:function(a){return 1>(a*=2)?.5*a*a*a*a*a:.5*((a-=2)*a*a*a*a+2)}},Sinusoidal:{In:function(a){return 1-Math.cos(a*Math.PI/2)},Out:function(a){return Math.sin(a*Math.PI/2)},InOut:function(a){return.5*(1-Math.cos(Math.PI*a))}},Exponential:{In:function(a){return 0===a?0:Math.pow(1024,a-1)},Out:function(a){return 1===a?1:1-Math.pow(2,-10*a)},InOut:function(a){return 0===a?0:1===a?1:1>(a*=2)?.5*Math.pow(1024,a-1):.5*(-Math.pow(2,-10*(a-1))+2)}},Circular:{In:function(a){return 1-Math.sqrt(1-a*a)},Out:function(a){return Math.sqrt(1- --a*a)},InOut:function(a){return 1>(a*=2)?-.5*(Math.sqrt(1-a*a)-1):.5*(Math.sqrt(1-(a-=2)*a)+1)}},Elastic:{In:function(a){var b,c=.1;return 0===a?0:1===a?1:(!c||1>c?(c=1,b=.1):b=.4*Math.asin(1/c)/(2*Math.PI),-(c*Math.pow(2,10*(a-=1))*Math.sin(2*(a-b)*Math.PI/.4)))},Out:function(a){var b,c=.1;return 0===a?0:1===a?1:(!c||1>c?(c=1,b=.1):b=.4*Math.asin(1/c)/(2*Math.PI),c*Math.pow(2,-10*a)*Math.sin(2*(a-b)*Math.PI/.4)+1)},InOut:function(a){var b,c=.1;return 0===a?0:1===a?1:(!c||1>c?(c=1,b=.1):b=.4*Math.asin(1/c)/(2*Math.PI),1>(a*=2)?-.5*c*Math.pow(2,10*(a-=1))*Math.sin(2*(a-b)*Math.PI/.4):.5*c*Math.pow(2,-10*(a-=1))*Math.sin(2*(a-b)*Math.PI/.4)+1)}},Back:{In:function(a){return a*a*(2.70158*a-1.70158)},Out:function(a){return--a*a*(2.70158*a+1.70158)+1},InOut:function(a){return 1>(a*=2)?.5*a*a*(3.5949095*a-2.5949095):.5*((a-=2)*a*(3.5949095*a+2.5949095)+2)}},Bounce:{In:function(a){return 1-b.Easing.Bounce.Out(1-a)},Out:function(a){return 1/2.75>a?7.5625*a*a:2/2.75>a?7.5625*(a-=1.5/2.75)*a+.75:2.5/2.75>a?7.5625*(a-=2.25/2.75)*a+.9375:7.5625*(a-=2.625/2.75)*a+.984375},InOut:function(a){return.5>a?.5*b.Easing.Bounce.In(2*a):.5*b.Easing.Bounce.Out(2*a-1)+.5}}},b.Interpolation={Linear:function(a,c){var d=a.length-1,e=d*c,f=Math.floor(e),g=b.Interpolation.Utils.Linear;return 0>c?g(a[0],a[1],e):c>1?g(a[d],a[d-1],d-e):g(a[f],a[f+1>d?d:f+1],e-f)},Bezier:function(a,c){var d,e=0,f=a.length-1,g=Math.pow,h=b.Interpolation.Utils.Bernstein;for(d=0;f>=d;d++)e+=g(1-c,f-d)*g(c,d)*a[d]*h(f,d);return e},CatmullRom:function(a,c){var d=a.length-1,e=d*c,f=Math.floor(e),g=b.Interpolation.Utils.CatmullRom;return a[0]===a[d]?(0>c&&(f=Math.floor(e=d*(1+c))),g(a[(f-1+d)%d],a[f],a[(f+1)%d],a[(f+2)%d],e-f)):0>c?a[0]-(g(a[0],a[0],a[1],a[1],-e)-a[0]):c>1?a[d]-(g(a[d],a[d],a[d-1],a[d-1],e-d)-a[d]):g(a[f?f-1:0],a[f],a[f+1>d?d:f+1],a[f+2>d?d:f+2],e-f)},Utils:{Linear:function(a,b,c){return(b-a)*c+a},Bernstein:function(a,c){var d=b.Interpolation.Utils.Factorial;return d(a)/d(c)/d(a-c)},Factorial:function(){var a=[1];return function(b){var c,d=1;if(a[b])return a[b];for(c=b;c>1;c--)d*=c;return a[b]=d}}(),CatmullRom:function(a,b,c,d,e){var a=.5*(c-a),d=.5*(d-b),f=e*e;return(2*b-2*c+a+d)*e*f+(-3*b+3*c-2*a-d)*f+a*e+b}}},a=b}(),c=function(){"use strict";var a,b=function(a){for(var b="",c=_.escape,d=(Array.prototype.join,a.mainFoods.length);d--;)b+='<span class="dish single_main_food" data-foodid="'+c(a.mainFoods[d].id)+'">'+c(a.mainFoods[d].name)+"</span>";return b};return a=b}(),d=function(){"use strict";var a,b=function(a){{var b,c="",d=_.escape;Array.prototype.join}return a.isImgFood?(c+='<a class="dish-favor favor_btn ',a.isFavor&&(c+="ui_favored"),c+='" title="收藏">&hearts;</a><a class="rst-d-img-wrapper food_img"><img class="rst-d-img" src="'+d(a.img)+'" alt="'+d(a.name)+'" />',a.activityImages&&a.activityImages.length>0&&""!==a.activityImages[0]&&(c+='<img class="activity-badge" src="'+d(ELEME.fussHost+a.activityImages[0])+'" alt="data.activityIcons[0].desc" />'),""!==a.description&&(c+='<div class="rst-d-desc" title="'+d(a.description)+'">'+d(a.description)+"</div>"),c+='</a><div class="rst-d-img-dish"><a class="rst-d-name food_name" title="'+d(a.name)+'">'+d(a.name)+'</a><br><span class="rst-d-rating food_rating cmt_block"><i class="icon-d-star s'+d(a.star)+' i_s"></i>',a.ratingCount>0&&(c+="("+(null==(b=a.ratingCount)?"":b)+")"),c+="</span>",(a.attributes.length>0||a.sales>0)&&(c+='<br><span class="rst-d-sales cmt_block">',_.each(a.attributes,function(a){c+='<i class="icon-rst-badge '+d(a)+'"></i>'}),a.sales>0&&(c+="月售"+(null==(b=a.sales)?"":b)+"份"),c+="</span>"),c+='<div class="rst-d-action r_d_a">',"rest"===ELEME.restaurantStatus?c+='<div class="unavailable symbol-rmb">'+d(a.price)+'<br><span class="status">餐厅休息</span></div>':0===a.stock?c+='<div class="unavailable symbol-rmb">'+d(a.price)+'<br><span class="status">已售完</span></div>':(c+='<div class="rst-d-act narrow act_btns"><a class="rst-d-act-add add_btn" title="点击饿一份" role="button"><span class="rst-d-act-glyph">&#xe017;</span><span class="price symbol-rmb">'+d(a.price)+'</span></a><a class="rst-d-act-toggle caret add_main_btn" role="button"></a></div>',(a.mustPayOnline||a.mustNewUser||a.originPrice)&&(c+='<div class="rst-d-paytip">',a.originPrice&&(c+='原价<span class="original-price symbol-rmb">'+d(a.originPrice)+"</span><br>"),a.mustPayOnline?c+="限在线支付":a.mustNewUser&&(c+="限新用户"),c+="</div>")),c+="</div>","rest"!==ELEME.restaurantStauts&&a.stock>0&&(c+='<div class="rst-d-note"><span class="rst-d-ordered dish_state ',a.inBasket||(c+="hide"),c+='">'+(null==(b=a.inBasket)?"":b)+"</span></div>"),c+="</div>"):(c+='<div class="rst-d-info"><p class="rst-d-main"><a class="dish-favor-flat favor_btn ',a.isFavor&&(c+="ui_favored"),c+='" title="收藏">&hearts;</a><a class="rst-d-name food_name" title="'+d(a.name)+'">',c+=a.name.length>20?d(a.name.substr(0,19))+"&hellip;":d(a.name),c+="</a>",a.activityImages&&a.activityImages.length>0&&""!==a.activityImages[0]&&(c+='<img class="activity-badge" src="'+d(ELEME.fussHost+a.activityImages[0])+'" alt="data.activityIcons[0].desc" />'),_.each(a.attributes,function(a){c+='<i class="icon-rst-badge '+d(a)+'"></i>'}),c+="</p>",""!==a.description&&(c+='<p class="rst-d-desc" title="'+d(a.description)+'">'+d(a.description)+"</p>"),c+='</div><div class="rst-d-note">',"rest"!==ELEME.restaurantStauts&&a.stock>0&&(c+='<span class="rst-d-ordered dish_state ',a.inBasket||(c+="hide"),c+='">'+(null==(b=a.inBasket)?"":b)+"</span>"),c+='</div><div class="rst-d-action r_d_a">',"rest"===ELEME.restaurantStatus?c+='<div class="unavailable symbol-rmb">'+d(a.price)+'<br><span class="status">餐厅休息</span></div>':0===a.stock?c+='<div class="unavailable symbol-rmb">'+d(a.price)+'<br><span class="status">已售完</span></div>':(a.originPrice&&(c+='<div class="rst-d-paytip oprice">原价<span class="original-price symbol-rmb">'+d(a.originPrice)+"</span></div>"),c+='<div class="rst-d-act act_btns"><a class="rst-d-act-add add_btn" title="点击饿一份" role="button"><span class="rst-d-act-glyph">&#xe017;</span><span class="price symbol-rmb">'+d(a.price)+'</span></a><a class="rst-d-act-toggle caret add_main_btn" role="button"></a></div>',a.mustPayOnline?c+='<div class="rst-d-paytip">限在线支付</div>':a.mustNewUser&&(c+='<div class="rst-d-paytip">限新用户</div>')),c+='</div><div class="rst-d-status cmt_block"><span class="rst-d-rating food_rating"><i class="icon-d-star s'+d(a.star)+' i_s"></i>',a.ratingCount>0&&(c+="("+(null==(b=a.ratingCount)?"":b)+")"),c+="</span>",a.sales>0&&(c+='<br><span class="rst-d-sales">月售'+(null==(b=a.sales)?"":b)+"份</span>"),c+="</div>"),c};return a=b}(),e=function(){"use strict";var a,b=function(a){var b="",c=_.escape;return b+='<div id="clear_cart_panel" class="rst-hint-modal clear-cart"><p>篮子中已有「'+c(a.restaurantName)+"」的美食，清空篮子后才能加入「"+c(a.foodName)+'」</p><p class="btn-wrapper"><a id="cancel_clear_cart" class="ui-btn">再等等</a><a id="clear_cart" class="ui-btn btn-confirm">清空并添加</a></p></div>'};return a=b}(),f=function(a,b,c,d,e){"use strict";function f(a){a=a||{},this.id=null,this.food=a.food,this.events={},this.buffer=null,this.init(a)}function g(a){a=a||{},this.content=a.content||[],this.childViews=[],this.buffer=null,this.init()}function h(a){h._super.call(this,a)}function i(a){i._super.call(this,a)}var j={},k=a,l=b,m=c,n=d,o=e,p=Eleme.Common.Evt,q=Eleme.Common.Util,r=Eleme.Common.PubSub,s={addMainBtnSelector:".add_main_btn",mainFoodSelector:".main-food",bookBtnSelector:".favor_btn",menuSelector:".main_food_panel",btnsSelector:".act_btns",cartTipSelector:"#clear_cart_panel",basketStateSelector:".dish_state",addFoodTopic:"addFoodToBasket",showMainFoodTopic:"showMainFood",showCommentTopic:"showSlide",getBasketInfoTopic:"getBasketInfo",addAnimEndTopic:"addAnimEnd",basketSyncSuccessTopic:"basketSyncSuccess",mainFoodMenuTpl:'<div class="rst-d-act-dropdown main_food_panel"><span class="helper">添加到以下菜品中</span></div>',elemClassName:"rst-dish-item",imgElemClassName:"rst-dish-img-item",bookStateClass:"ui_favored"};return $.extend(f.prototype,p,k),f.prototype.type="food_view",f.prototype.tagName="li",f.prototype.init=function(){this.id=this.type+"_"+this.food.values.id,this.listenTo(this.food,"basketStateChange",this.basketStateHandler,this),this.listenTo(this.food,"favorStateChange.food",this.favorStateHandler,this),this.listenTo(this.food,"invalidBasket",this.showClearCartPanel,this),Eleme.View.views[this.id]=this},f.prototype.$el=function(){return $("#"+this.id)},f.prototype.handleAdd=function(a){var b=r.publish(s.getBasketInfoTopic);return b.restaurantId&&b.restaurantId!==ELEME.restaurantId?(this.showClearCartPanel(b),void a.stopPropagation()):void this.addToBasket()},f.prototype.handleAddMain=function(a){var b,c;return b=r.publish(s.getBasketInfoTopic,ELEME.restaurantId),b.restaurantId&&b.restaurantId!==ELEME.restaurantId?(this.showClearCartPanel(b),void a.stopPropagation()):(c=this.$el().find(s.menuSelector),c.length?void(c.parent().hasClass("ui_open")&&(c.parent().removeClass("ui_open"),c.remove())):(this.clearMenu(),r.publish(s.showMainFoodTopic,$.proxy(this.showMainFoodPanel,this)),void a.stopPropagation()))},f.prototype.showMainFoodPanel=function(a,b){var c=$(s.mainFoodMenuTpl);c.append(m({mainFoods:b})),this.$el().find(s.addMainBtnSelector).parent().append(c).addClass("ui_open")},f.prototype.addToMainFood=function(a){this.addToBasket({mainFoodId:a}),this.$el().find(s.mainFoodSelector).hide()},f.prototype.render=function(a){var b=this.food.values;return b.isImgFood&&(b.img=ELEME.fussHost+this.makeImgSrc()),this.buffer=a,a.begin(this.tagName),this.addPropertyToBuffer(a),a.pushOpenTag(),a.push(n(b)),a.pushCloseTag(),this},f.prototype.addPropertyToBuffer=function(a){var b=this.food.values.isImgFood?s.imgElemClassName:s.elemClassName,c="";b===this.food.values.originPrice&&(this.food.values.mustPayOnline||this.food.values.mustNewUser)&&(c=" patch-height"),a.setId(this.id),a.setClass(b+c+" eleme_view")},f.prototype.destroy=function(){this.stopListening(this.food),this.$el().remove()},f.prototype.makeImgSrc=function(){var a="?w=240&h=180";return this.food.values.originImg||(this.food.values.originImg=this.food.values.img),this.food.values.originImg+a},f.prototype.showComment=function(){r.publish(s.showCommentTopic,this.food)},f.prototype.favorFood=function(){this.food.favor()},f.prototype.addToBasket=function(a){var b=this.$el().find(s.basketStateSelector);return b.html("").removeClass("hide").addClass("loading"),r.publish(s.addFoodTopic,$.proxy(this.food.addToBasket,this.food),a),this.addFoodAnim(),r.publish("addFoodToBasketAnim",this),this},f.prototype.showClearCartPanel=function(a){a=a||{};var b=this.$el().find(s.btnsSelector),c=this.$el().find(s.basketStateSelector),d=b.find(s.cartTipSelector);c.addClass("hide").removeClass("loading"),d.length||($(document).find(s.cartTipSelector).remove(),a.foodName=this.food.values.name,a.restaurantName=a.restaurantName||"其他餐厅",b.append(o(a)))},f.prototype.favorStateHandler=function(){var a=this.$el().find(s.bookBtnSelector);this.food.values.isFavor?a.addClass(s.bookStateClass):a.removeClass(s.bookStateClass)},f.prototype.basketStateHandler=function(){var a=this.$el().find(s.basketStateSelector);a.removeClass("loading").html(this.food.values.inBasket),0===this.food.values.inBasket?a.addClass("hide"):a.removeClass("hide")},f.prototype.scrollToView=function(a){var b=this.$el().offset().top;$("html, body").animate({scrollTop:b-42+"px"},{complete:a})},f.prototype.clearMenu=function(){var a=$(s.menuSelector),b=a.parent(s.btnsSelector);b.hasClass("ui_open")&&(b.removeClass("ui_open"),a.remove())},f.prototype.clearCartTipMenu=function(){this.$el().find(s.cartTipSelector).remove()},f.prototype.addFoodAnim=function(){function a(){new l.Tween({x:0,y:0,old:{x:0,y:0}}).to({x:[.6*c.x,c.x],y:[Math.min(-150,c.y-100),c.y]},700).interpolation(l.Interpolation.Bezier).easing(l.Easing.Quadratic.Out).onUpdate(function(){i.css({left:this.x+d.left+"px",top:this.y+d.top+"px"}),this.old.x=this.x,this.old.y=this.y}).onComplete(function(){i.remove(),r.publish(s.addAnimEndTopic)}).start()}function b(){o(b),l.update()}var c,d,e,f=$(window).scrollTop(),g=$(".current_basket_tile"),h=g.offset(),i=$('<span id="anim_price_tip" class="rst-animate-tip">'+this.food.values.price+"</span>"),j=this.$el().find(".act_btns"),k=j.offset(),m=j.width(),n=j.height();r.subscribeOnce(s.basketSyncSuccessTopic,function(){i.appendTo(document.body),d={left:k.left+m/2-i.outerWidth(!0)/2,top:k.top-f+n/2-i.outerHeight(!0)/2},e={left:h.left+g.width()/2-i.outerWidth(!0)/2,top:h.top-f},c={x:e.left-d.left,y:e.top-d.top},a(),b()},this);{var o=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame||function(a){window.setTimeout(a,16)};window.cancelAnimationFrame||window.mozCancelAnimationFrame||window.webkitCancelAnimationFrame||window.msCancelAnimationFrame||function(a){window.clearTimeout(a)}}},g.prototype.childViewClass=f,g.prototype.className="",g.prototype.type="plain_collection_view",g.prototype.init=function(){this.id=this.type+"_"+Eleme.View.uuid++,this.createChildView()},g.prototype.$el=function(){return $("#"+this.id)},g.prototype.createChildView=function(){var a,b,c;for(a=0,b=this.content.length;b>a;a++)c=new this.childViewClass({food:this.content[a]}),this.childViews.push(c);this.originChildViews=this.childViews},g.prototype.render=function(a){this.content.length>0&&(this.buffer=a,a.begin("ul"),a.setId(this.id),a.setClass(this.className),a.pushOpenTag(),this._renderFood(this.childViews,a),a.pushCloseTag())},g.prototype._renderFood=function(a,b){var c,d;for(c=0,d=a.length;d>c;c++)a[c].render(b)},g.prototype.clearBuffer=function(){this.buffer=null;for(var a=this.childViews.length;a--;)this.childViews[a].buffer=null},g.prototype.findByFoodId=function(a){for(var b=this.childViews.length;b--;)if(this.childViews[b].food.values.id===a)return this.childViews[b]},g.prototype._destroyFoodView=function(){for(var a;a=this.childViews.pop();)delete Eleme.View.views[a.id],a.destroy()},g.prototype.scrollFoodToView=function(a,b){for(var c=this.childViews.length;c--;)if(a===this.childViews[c].food.values.id){this.childViews[c].scrollToView(b);break}},g.prototype.sort=function(a,b){var c;"default"===a?this.childViews=this.originChildViews:this.childViews.length>0&&(c="desc"===b?function(b){return-b.food.values[a]}:function(b){return b.food.values[a]},this.childViews=_.sortBy(this.childViews,c))},q.inherit(h,g),h.prototype.className="rst-menu-img-list",q.inherit(i,g),i.prototype.className="rst-menu-list",j.FoodView=f,j.FoodCollectionView=g,j.PlainFoodCollectionView=i,j.ImgFoodCollectionView=h,j}(a,b,c,d,e),g=function(){"use strict";var a,b=function(a){{var b,c="",d=_.escape;Array.prototype.join}if(c+='<a class="album-cover food_cover"><img class="album-cover-img food_img" src="'+d(ELEME.fussHost+a.cover.image+"?w=275&h=275")+'" alt="'+d(a.name)+'" title="'+d(a.name)+'" /></a><a class="dish-favor favor_btn ',a.isFavor&&(c+="ui_favored"),c+='" title="收藏">&hearts;</a><a class="photo-like like_btn',1===a.cover.liked&&(c+=" ui_liked"),c+='" title="赞">赞<span class="photo-like-count like_count',0===a.cover.like_count&&(c+=" ui_hide"),c+='">'+(null==(b=a.cover.like_count)?"":b)+'</span></a><div class="album-dish',a.count>1&&(c+=" with-photos"),c+='"><div class="album-dish-name food_name" title="'+d(a.name)+'">'+d(a.name)+'</div><div class="album-dish-rating"><i class="icon-d-star s'+d(Math.round(2*a.rating))+'"></i>',a.ratingCount>0&&(c+="("+d(a.ratingCount)+")"),c+="</div>",a.sales>0||a.activity){if(c+='<div class="album-dish-sale">',a.activity){var e=a.activity;if(e.activityType&&"secKill"===e.activityType)c+='<i class="icon-rst-badge half-price" title="周二半价"></i>';else if(e.activityIcons.length>0){var f=e.activityIcons[0];c+=f.url.length>0?'<img class="icon-rst-badge" src="'+d(ELEME.fussHost+f.url)+'" alt="'+d(f.desc)+'" title="'+d(f.desc)+'" />':'<i class="icon-rst-badge default-activity" title="促销活动"></i>'}}a.sales>0&&(c+="月售"+d(a.sales)+"份"),c+="</div>"}return c+='<div class="rst-d-action r_d_a">',c+="rest"===ELEME.restaurantStatus?'<div class="unavailable symbol-rmb">'+d(a.price)+'<br /><span class="status">餐厅休息</span></div>':0===a.stock?'<div class="unavailable symbol-rmb">'+d(a.price)+'<br /><span class="status">已售完</span></div>':'<div class="rst-d-act narrow act_btns"><a class="rst-d-act-add add_btn" title="点击饿一份" role="button"><span class="rst-d-act-glyph">&#xe017;</span><span class="price symbol-rmb">'+d(a.price)+'</span></a><a class="rst-d-act-toggle caret add_main_btn" role="button"></a></div>',c+="</div>","rest"!==ELEME.restaurantStatus&&a.stock>0&&(c+='<div class="rst-d-note">',a.activity&&(a.activity.mustPayOnline?c+='<span class="rst-d-paytip">限在线支付</span>':a.activity.mustNewUser&&(c+='<span class="rst-d-paytip">限新用户</span>')),c+='<span class="rst-d-ordered dish_state ',a.inBasket||(c+="hide"),c+='">'+(null==(b=a.inBasket)?"":b)+"</span></div>"),c+="</div>"};return a=b}(),h=function(a,b){"use strict";function c(a){c._super.call(this,a)}function d(a){this.active=!1,d._super.call(this,a)}var e={},f=a.FoodView,g=a.FoodCollectionView,h=b,i=Eleme.Common.Util,j=Eleme.Common.PubSub,k={foodListSelector:"#food_wrap",likeBtnSelector:".like_btn",likeCountSelector:".like_count",launchGalleryTopic:"launchGallery"};return i.inherit(c,g),c.prototype.childViewClass=d,c.prototype.init=function(){this.$el=$(k.foodListSelector),this.createChildView()},c.prototype.renderPartial=function(a,b){b=b||{min:0,max:this.childViews.length};var c;c=this.childViews.slice(b.min,b.max),this._renderFood(c,a)},c.prototype.render=function(a){this._renderFood(this.childViews,a)},c.prototype.getRange=function(){for(var a=0,b=this.childViews.length;b>a;a++)if(!this.childViews[a].active)return a},c.prototype.setActive=function(a,b){for(var c=a;b>c;c++)this.childViews[c].active=!0},c.prototype.tagLikeCover=function(a){_.each(this.childViews,function(b){var c=b.food.photo,d=b.food.photo.values.id;-1!==_.indexOf(a,d)&&(c.values.liked=1,c.trigger("likeStateChange"))})},c.prototype.sortByLike=function(){this.childViews=_.sortBy(this.childViews,function(a){return-a.food.photo.values.like_count})},c.prototype.launchGallery=function(a){_.each(this.childViews,function(b){a===b.food.values.id&&b.launchGallery()})},i.inherit(d,f),d.prototype.tagName="div",d.prototype.type="wall_view",d.prototype.className="rst-block album-block eleme_view",d.prototype.init=function(){this.id=this.type+"_"+this.food.values.id,this.listenTo(this.food,"basketStateChange",this.basketStateHandler,this),this.listenTo(this.food,"favorStateChange.food",this.favorStateHandler,this),this.listenTo(this.food,"invalidBasket",this.showClearCartPanel,this),this.listenTo(this.food.photo,"likeStateChange",$.proxy(this.likeHandler,this)),Eleme.View.views[this.id]=this},d.prototype.render=function(a){a.begin(this.tagName),a.setId(this.id),a.setClass(this.className),a.pushOpenTag(),a.push(h(this.food.values)),a.pushCloseTag()},d.prototype.like=function(){var a=this.food.photo;a.values.liked?a.dislike():a.like()},d.prototype.likeHandler=function(){var a=this.food.photo,b=a.values.like_count,c=this.$el().find(k.likeCountSelector);a.values.liked?this.$el().find(k.likeBtnSelector).addClass("ui_liked"):this.$el().find(k.likeBtnSelector).removeClass("ui_liked"),0===b?c.addClass("ui_hide").text(b):c.removeClass("ui_hide").text(b)},d.prototype.launchGallery=function(){j.publish(k.launchGalleryTopic,this.food)},e.WallFoodView=d,e.WallFoodCollectionView=c,e}(f,g),i=function(){"use strict";function a(a,b){this.values=a,this.events={},this.init(b)}var b,c=Eleme.Common.Evt,d=Eleme.Common.PubSub,e=Eleme.Common.Http,f={basketSyncSuccessTopic:"basketSyncSuccess",favorFoodUpdateTopic:"favorFoodUpdate",invalidBasketCode:1002};return $.extend(a.prototype,c),a.prototype.init=function(){this.buildSearchIndex(),this.setDefaults(),this.values.star=Math.round(2*this.values.rating),""!==this.values.img&&(this.values.isImgFood=!0)},a.prototype.buildSearchIndex=function(){this.values.searchIndex=this.values.name,this.values.pinyinName&&(this.values.searchIndex+=this.values.pinyinName)},a.prototype.setDefaults=function(){_.defaults(this.values,{basket:{},isFavor:!1}),this.values.activityImages&&(this.values.activityImages=this.values.activityImages.slice(0,1)),this.values.description=$.trim(this.values.description)},a.prototype.favor=function(){var a,b,c;this.values.isFavor?(a="unfavor",b={url:"/"+this.values.id+"/unfavor"},c=this.unFavorHandler):(a="favor",b={url:"/"+this.values.id+"/favor"},c=this.favorHandler),this.sync(a,b).then($.proxy(c,this))},a.prototype.sync=function(a,b){var c=b.payload||{},d={favor:{url:"/food"+b.url,type:"get"},unfavor:{url:"/food"+b.url,type:"get"},add:{url:"/cart/add"+b.url,type:"get"}},f="//"+ELEME.mainHost+d[a].url,g=d[a].type;if(!f)throw new Error("invalid food sync");return e.request({type:g,url:f,data:c,dataType:"jsonp"})},a.prototype.addToBasket=function(a){a=a||{};var b={num:1},c=a.basketId||0,d=a.mainFoodId||0;a.force&&(b.forced=1),this.values.basket[c]||(this.values.basket[c]=0),this.sync("add",{url:"/"+c+"/"+d+"/"+this.values.id,payload:b}).then($.proxy(this.addToBasketHandler,this),$.proxy(this.addFoodFailureHandler,this))},a.prototype.addFoodFailureHandler=function(a){a&&a.code===f.invalidBasketCode&&this.trigger("invalidBasket")},a.prototype.addToBasketHandler=function(a){d.publish(f.basketSyncSuccessTopic,a)},a.prototype.favorHandler=function(a){a.success&&(this.values.isFavor=!0,this.trigger("favorStateChange.commentFood"),this.trigger("favorStateChange.food"),d.publish(f.favorFoodUpdateTopic,this,{favor:!0}))},a.prototype.unFavorHandler=function(a){a.success&&(this.values.isFavor=!1,this.trigger("favorStateChange.commentFood"),this.trigger("favorStateChange.food"),d.publish(f.favorFoodUpdateTopic,this,{favor:!1}))},b=a}(),j=function(){"use strict";function a(a){this.values=a,this.init()}var b,c=Eleme.Common.Evt,d=Eleme.Common.Http;return $.extend(a.prototype,c),a.prototype.init=function(){!this.id,this.setDefaults()},a.prototype.setDefaults=function(){this.values.liked=this.values.liked||0},a.prototype.like=function(){var a=this;this.sync({type:"POST",url:"/photo/"+this.values.id+"/like"}).done(function(b){a.values.liked=1,a.values.like_count=b.count,a.trigger("likeStateChange")})},a.prototype.dislike=function(){var a=this;this.sync({type:"POST",url:"/photo/"+this.values.id+"/dislike"}).done(function(b){a.values.liked=0,a.values.like_count=b.count,a.trigger("likeStateChange")})},a.prototype.report=function(){},a.prototype.sync=function(a){var b=a.url,c=a.type;return b="//"+ELEME.mainHost+ELEME.baseUrl+b,d.request({type:c,url:b,dataType:"jsonp"})},b=a}(),k=function(a,b){"use strict";function c(a,b){this.photo=new f(a.cover),c._super.call(this,a,b)}var d,e=a,f=b,g=Eleme.Common.Util;return g.inherit(c,e),c.prototype.init=function(){this.setDefaults(),this.values.star=Math.round(2*this.values.rating),this.values.isImgFood=!0},d=c}(i,j),l=function(a,b,c){"use strict";function d(){this.foodCollectionView=null,this.foods=[],this.lastFoodsId=[],this.likePhotos=[],this.renderComplete=!1,this.init()}function e(a){var b=$(a.target),c=b.closest(".eleme_view").attr("id"),d=Eleme.View.views[c];return d}var f,g=a.WallFoodCollectionView,h=b,i=Eleme.Common.Http,j=Eleme.Common.PubSub,k=Eleme.Common.RenderBuffer,l={wallWrapSelector:"#wall_wrap",wallModalWrapSelector:".wall_modal_wrap",backdropSelector:".modal_backdrop",foodWrapSelector:"#food_wrap",loadMoreSelector:".load_more",sortBtnSelector:".sort_btn",menuSelector:".main_food_panel",cartTipSelector:"#clear_cart_panel",mapSelector:".rst_map",restaurantDeliverAmountSelector:".rst_deliver_amount",restaurantInfoPanelSelector:".rst_info_panel",headDistanceSelector:".rst_head_distance",restaurantDistanceSelector:".rst_distance",favorBtnSelector:".favor_btn",addBtnSelector:".add_btn",addMainBtnSelector:".add_main_btn",foodCoverSelector:".food_cover",foodNameSelector:".food_name",likeBtnSelector:".like_btn",clearCartSelector:"#clear_cart",cancelClearCartSelector:"#cancel_clear_cart",singleMainFoodSelector:".single_main_food",restaurantInfoDoneTopic:"restaurantInfoDone",launchGalleryTopic:"launchGallery",basketSyncSuccessTopic:"basketSyncSuccess",basketInitTopic:"basketInit",openLoginPanelTopic:"openLoginPanel",userInfoUrl:"/"+ELEME.restaurantUrl+"/userinfo"},m=$(window),n=$(document),o=m.height(),p=n.height();return d.prototype.init=function(){var a=this;this.$el=$(l.wallWrapSelector),this.createWallView(),$(function(){a.checkFood()}),this.bindEvents(),this.subscribeTopic(),window.wallRenderIndex===this.foods.length&&(this.renderComplete=!0),this.foodCollectionView.setActive(0,window.wallRenderIndex+1),Eleme.Component.scrollspy("moreFood",{min:p-o-500,onEnter:function(b){var c,d=0;a.renderComplete||(c=a.getRenderRange(),a.render({range:c}),p=n.height(),b.min=p+d-o-500)}}),this.fetchLikePhotos()},d.prototype.bindEvents=function(){function a(){var a=$(l.menuSelector),b=a.parent(".rst-d-act");b.hasClass("ui_open")&&(b.removeClass("ui_open"),a.remove())}function b(){var a=$(l.cartTipSelector);a.length>0&&a.remove()}var c=this;n.on("click",a).on("click",b),this.$el.find(l.sortBtnSelector).on("click",function(){var a=$(this).data("method");$(this).addClass("ui_active").siblings().removeClass("ui_active"),c.sort(a),c.rerender(),c.renderComplete=!0}),this.$el.on("click",l.likeBtnSelector,function(a){ELEME.authed?e(a).like():j.publish(l.openLoginPanelTopic)}).on("click",l.foodCoverSelector+", "+l.foodNameSelector,function(a){e(a).launchGallery()}).on("click",l.favorBtnSelector,function(a){ELEME.authed?e(a).favorFood():j.publish(l.openLoginPanelTopic)}).on("click",l.addBtnSelector,function(a){e(a).handleAdd(a)}).on("click",l.addMainBtnSelector,function(a){e(a).handleAddMain(a)}).on("click",l.cancelClearCartSelector,function(a){e(a).clearCartTipMenu()}).on("click",l.clearCartSelector,function(a){e(a).addToBasket({force:!0}).clearCartTipMenu()}).on("click",l.singleMainFoodSelector,function(a){var b=$(this).data("foodid"),c=e(a);c.addToMainFood(b),c.clearMenu()})},d.prototype.subscribeTopic=function(){j.subscribeOnce(l.basketInitTopic,this.tagFoodView,this),j.subscribe(l.basketSyncSuccessTopic,this.tagFoodView,this),j.subscribe(l.restaurantInfoDoneTopic,function(a){var b,c,d,e=[],f=a.favorFoodIds;if(0===f.length)return void j.publish(l.favorFoodInitTopic,e);for(b=f.length;b--;)d=f[b],c=_.find(this.foods,function(a){return a.values.id===d}),c&&(c.values.isFavor=!0,c.trigger("favorStateChange.food"),e.push(c));j.publish(l.favorFoodInitTopic,e)},this)},d.prototype.fetchLikePhotos=function(){var a=this,b="//"+location.host+ELEME.baseUrl+"/"+ELEME.restaurantUrl+"/likedCover";i.request({type:"GET",url:b}).then(function(b){a.tagLikeCover(b)})},d.prototype.createWallView=function(){this.foods=_.map(window.wallFoods,function(a){return new h(a)}),this.foodCollectionView=new g({content:this.foods,isImg:!0})},d.prototype.tagLikeCover=function(a){this.foodCollectionView.tagLikeCover(a)},d.prototype.tagFoodView=function(a){function b(a){var b;for(b=l.length;b--;)if(l[b].id===a.id)return void(l[b].quantity+=a.quantity);return!0}function c(a,b,c){var e;(e=d(a,b.id))&&(e.values.inBasket=c?0:b.quantity,e.trigger("basketStateChange"))}function d(a,b){return _.find(a,function(a){return a.values.id===b})}var e,f,g,h,i,j,k,l=[];for(j=_.flatten($.extend(!0,[],a.groups),!0),e=j.length;e--;)for(k=j[e].garnishes,g=j[e].id,b(j[e])&&l.push(j[e]),f=k.length;f--;)b(k[f])&&l.push(k[f]);for(e=this.lastFoodsId.length;e--;)i=this.lastFoodsId[e],c(this.foods,i,!0);for(e=l.length;e--;)h=l[e],c(this.foods,h,!1);this.lastFoodsId=l},d.prototype.render=function(a){var b,c=a.range;if(c){var d=new k;this.foodCollectionView.renderPartial(d,c),b=$(d.buffer),this.$el.find(l.foodWrapSelector).append(b)}},d.prototype.rerender=function(){var a=new k;this.foodCollectionView.render(a),this.$el.find(l.foodWrapSelector).empty().append(a.buffer)},d.prototype.sort=function(a,b){if(a){if("like"===a)return void this.foodCollectionView.sortByLike();b=b||"","price"!==a&&(b="desc"),this.foodCollectionView.sort(a,b)}},d.prototype.getRenderRange=function(){
var a,b;return(a=this.foodCollectionView.getRange())?(b=Math.min(this.foods.length,a+20),this.foods.length===b&&(this.renderComplete=!0),this.foodCollectionView.setActive(a,b),{min:a,max:b}):void(this.renderComplete=!0)},d.prototype.checkFood=function(){var a,b,c=window.location.hash;c.length<=1||(b=c.substr(1).split("/"),"food"===b[0]&&(a=window.parseInt(b[1],10),this.foodCollectionView.launchGallery(a)))},f=d}(h,k,i),m=function(){"use strict";var a,b=function(a){{var b,c="",d=_.escape;Array.prototype.join}return c+='<a class="photo-image-wrapper" href="'+d(ELEME.fussHost+a.image)+'" target="_blank"><img class="photo-image" src="'+d(ELEME.fussHost+a.image+"?w=275&h=275")+'" alt="'+d(a.username)+'" /></a><a class="photo-like like_btn',1===a.liked&&(c+=" ui_liked"),c+='" role="button" title="赞">赞<span class="photo-like-count like_count',0===a.like_count&&(c+=" ui_hide"),c+='">'+(null==(b=a.like_count)?"":b)+'</span></a><div class="photo-info">',(a.rating>0||""!==a.rating_text)&&(c+='<p class="photo-comment"><span class="icon-d-star s'+d(Math.round(2*a.rating))+'"></span>',""!==a.rating_text&&(c+="<br>"+d(a.rating_text)),c+="</p>"),c+='<div class="photo-misc group"><img class="photo-avatar" src="'+d(a.avatar)+'" alt="'+d(a.usermane)+'" />'+d(a.username)+"&nbsp;"+d(Eleme.Common.Time.format(a.created_at))+'<div class="photo-report"><div class="glyph-flag glyph report_flag"></div><div class="tooltip">举报菜图不匹配</div></div></div></div>'};return a=b}(),n=function(a){"use strict";function b(a){this.photo=a,this.id=null,this.init()}var c,d=a,e=Eleme.Common.Evt,f={likeBtnSelector:".like_btn",likeCountSelector:".like_count"};return $.extend(b.prototype,e),b.prototype.tagName="div",b.prototype.type="photo_view",b.prototype.classNames="rst-block photo-block eleme_view",b.prototype.init=function(){this.id=this.type+"_"+(this.photo.values.id||Eleme.View.uuid++),this.listenTo(this.photo,"likeStateChange",$.proxy(this.likeHandler,this)),Eleme.View.views[this.id]=this},b.prototype.$el=function(){return $("#"+this.id)},b.prototype.render=function(a){a.begin(this.tagName),a.setId(this.id),a.setClass(this.classNames),a.pushOpenTag(),a.push(d(this.photo.values)),a.pushCloseTag()},b.prototype.like=function(){this.photo.values.liked?this.photo.dislike():this.photo.like()},b.prototype.likeHandler=function(){var a=this.$el().find(f.likeBtnSelector),b=this.$el().find(f.likeCountSelector),c=this.photo.values.like_count;this.photo.values.liked?a.addClass("ui_liked"):a.removeClass("ui_liked"),0===c?b.addClass("ui_hide").text(c):b.removeClass("ui_hide").text(c)},b.prototype.report=function(){this.photo.report()},c=b}(m),o=function(){"use strict";var a,b={notificationWrapSelector:".notification_wrap",closeBtnSelector:".close_btn",notificationTpl:'<div class="ui-flash-note notification_wrap"></div>'},c={showNotification:function(a){if("string"==typeof a){var c,d=this,e=$(window),f=$(b.notificationTpl).text(a);$(document.body).append(f),f.css({left:(e.width()-f.outerWidth())/2+"px"}),c=window.setTimeout(function(){d.closeNotification()},2e3)}},closeNotification:function(){$(b.notificationWrapSelector).remove()}};return a=c}(),p=function(){"use strict";var a,b=function(a){{var b,c="",d=_.escape;Array.prototype.join}if(c+='<div class="rpm-dish-info food_info"><p class="rpm-dish-name">'+d(a.name)+'</p><p class="rpm-dish-rating">',a.activity){var e=a.activity;if(e.activityType&&"secKill"===e.activityType)c+='<i class="icon-rst-badge half-price" title="周二半价"></i>';else if(e.activityIcons.length>0){var f=e.activityIcons[0];c+=f.url.length>0?'<img class="icon-rst-badge" src="'+d(ELEME.fussHost+f.url)+'" alt="'+d(f.desc)+'" title="'+d(f.desc)+'" />':'<i class="icon-rst-badge default-activity" title="促销活动"></i>'}}c+='<i class="icon-d-star s'+(null==(b=a.star)?"":b)+'"></i>';var g=(Math.round(10*a.rating)/10).toString(),h=g.indexOf(".")>0?g:g+".0";return g>0&&(c+=d(h)),c+="</p></div>",a.activity&&(a.activity.mustPayOnline?c+='<div class="float-r rst-d-paytip">限在线支付</div>':a.activity.mustNewUser&&(c+='<div class="float-r rst-d-paytip">限新用户</div>')),c};return a=b}(),q=function(){"use strict";var a,b=function(a){var b="",c=_.escape;return b+='<div id="report_photo" class="rst-hint-modal photo-report-modal modal_content" data-photoid="'+c(a.photoId)+'"><p>你确定照片与这道菜不相符吗？</p><p class="btn-wrapper"><a class="ui-btn cancel_report_btn">取消</a><a class="ui-btn report_btn">确定</a></p></div>'};return a=b}(),r=function(a,b,c,d,e,f){"use strict";function g(){this.open=!1,this.loading=!1,this.photoEnd=!1,this.currentPage=1,this.photoCount=0,this.food=null,this.childViews=[],this.init()}function h(){for(var a,b=u.col,c=[];b--;)a=$(".col_"+b).last(),c.push(a.length?{col:b,height:a.position().top+a.outerHeight(!0)}:{col:b,height:0});return c.sort(function(a,b){var c;return c=a.height>b.height?1:a.height<b.height?-1:a.col>b.col?1:-1}),c}function i(a,b){var c=b.shift();a.addClass("col_"+c.col).css({left:c.col*(a.width()+14)+"px",top:c.height+"px"}).find("img").css("opacity","0").one("load",function(){$(this).animate({opacity:"1"})})}function j(a){var b=$(a.target),c=b.closest(".eleme_view").attr("id"),d=Eleme.View.views[c];return d}var k,l=a,m=b,n=c,o=d,p=e,q=f,r=Eleme.Common.Http,s=(Eleme.Common.Time,Eleme.Common.PubSub),t=Eleme.Common.RenderBuffer,u={galleryWrapSelector:"#modal_photo",foodInfoWrapSelector:".food_info_wrap",foodInfoSelector:".food_info",photoListSelector:".photo_list",loadMoreSelector:".load_more",likeBtnSelector:".like_btn",reportFlagSelector:".report_flag",reportPanelSelector:"#report_photo",cancelReportSelector:".cancel_report_btn",reportBtnSelector:".report_btn",reportsSuccessSelector:".report_success_tip",modalWrapSelector:".modal_wrap",backdropSelector:".modal_backdrop",modalContentSelector:".modal_content",launchGalleryTopic:"launchGallery",openLoginPanelTopic:"openLoginPanel",col:3};return $.extend(g.prototype,n,o),g.prototype.init=function(){this.$el=$(u.galleryWrapSelector),this.bindEvents(),this.subscribeTopic()},g.prototype.bindEvents=function(){var a=this;this.$el.on("hidden.bs.modal",function(){a.close(),a.destroy()}),this.$el.on("click",u.likeBtnSelector,function(a){ELEME.authed?j(a).like():s.publish(u.openLoginPanelTopic)}),this.$el.on("click",u.reportFlagSelector,function(b){var c,d,e,f,g,h,i,k=$(window);c=j(b),ELEME.authed?(d=c.photo.values.id,e=$(q({photoId:d})),a.showModal(e),f=c.$el(),g=f.offset(),h=k.scrollTop()+k.height()-g.top-f.outerHeight(),i=$(document).width()-f.outerWidth()-g.left+"px",e.css({right:i,bottom:h})):s.publish(u.openLoginPanelTopic)}),this.$el.on("click",u.cancelReportSelector+","+u.backdropSelector,function(){a.hideModal()}),this.$el.on("click",u.reportBtnSelector,function(b){var c=$(b.target).closest(u.reportPanelSelector),d=c.data("photoid");a.hideModal(),a.reportPhoto(d).done(function(b){b.success&&a.showNotification("提交成功，我们会尽快处理")})})},g.prototype.subscribeTopic=function(){s.subscribe(u.launchGalleryTopic,function(a){this.launch(a)},this)},g.prototype.launch=function(a){var b=this,c=$.Deferred();this.food=a,this.currentPage=1,this.open=!0;var d=this.fetch({init:!0});this.renderFoodInfo(),this.$el.modal("show"),setTimeout(function(){c.resolve()},500),$.when(d,c).done(function(a){b.render(a.photos)}),this.$el.on("scroll.gallery",function(){b.loading||b.photoEnd||b.loadMore()})},g.prototype.close=function(){this.open=!1,this.loading=!1,this.photoEnd=!1,this.currentPage=1,this.photoCount=0,this.childViews.length=0,this.hideModal(),window.location.hash.length>2&&(window.location.hash="#!"),this.$el.off("scroll.gallery")},g.prototype.renderFoodInfo=function(){var a=p(this.food.values);this.$el.find(u.foodInfoWrapSelector).append(a)},g.prototype.render=function(a,b){b=b||{};var c,d=this,e=this.$el.find(u.photoListSelector),f=this.$el.find(u.loadMoreSelector),g=new t;_.each(a,function(a){var b,c;a.id!==d.food.photo.values.id?b=new l(a):(_.defaults(d.food.photo.values,a),b=d.food.photo),c=new m(b),c.render(g),d.childViews.push(c)}),c=$(g.buffer),b.loadMore?e.append(c):e.empty().append(c),f.addClass("ui_hide"),this.adjust(c),this.loading=!1},g.prototype.adjust=function(a){a=a||[];var b,c,d,e,f,g,j=0,k=u.col;for(b=0,d=a.length;d>b;b+=k)for(g=h(),c=0,e=Math.min(d-b,k);e>c;c++)i(a.eq(b+c),g);for(;k--;)f=$(".col_"+k).last(),f.length&&(j=Math.max(j,f.outerHeight(!0)+f.position().top));this.$el.find(u.photoListSelector).height(j),a.css("visibility","visible")},g.prototype.fetch=function(a){a=a||{};var b=this,c="http://"+ELEME.mainHost+ELEME.baseUrl+"/food/"+this.food.values.id+"/photos",d={page:this.currentPage};return this.loading=!0,a.init||this.$el.find(u.loadMoreSelector).removeClass("ui_hide"),r.request({url:c,type:"get",dataType:"jsonp",data:d}).then(function(a){return b.currentPage++,b.photoCount+=a.photos.length,b.photoCount===a.total&&(b.photoEnd=!0),a})},g.prototype.loadMore=function(){var a=this;this.checkBottom()&&this.fetch().then(function(b){a.render(b.photos,{loadMore:!0})})},g.prototype.reportPhoto=function(a){var b="http://"+ELEME.mainHost+ELEME.baseUrl+"/photo/"+a+"/report";return r.request({type:"GET",url:b,dataType:"jsonp"})},g.prototype.checkBottom=function(){var a=this.$el.scrollTop(),b=this.$el[0].scrollHeight;return b-a<$(window).height()+400},g.prototype.destroy=function(){this.$el.find(u.foodInfoSelector).remove(),this.$el.find(u.photoListSelector).css("height","").empty()},k=g}(j,n,a,o,p,q),s=function(){"use strict";function a(a){this.values=a,this.init()}var b,c=Eleme.Common.PubSub,d=Eleme.Common.Http,e={basketSyncSuccessTopic:"basketSyncSuccess",basketSyncFailureTopic:"basketSyncError"};return a.prototype.init=function(){this.setDefault()},a.prototype.setDefault=function(){_.defaults(this.values,{foods:[]})},a.prototype.clear=function(){var a={},b="//"+ELEME.mainHost+"/cart/clear/"+this.values.id;d.request({type:"get",url:b,data:a,dataType:"jsonp"}).done(function(a){c.publish(e.basketSyncSuccessTopic,a,{basket:!0})}).fail(function(a){c.publish(e.basketSyncFailureTopic,a,{basket:!0})})},b=a}(),t=function(){"use strict";function a(a){this.values=a,this.init()}var b,c=Eleme.Common.PubSub,d=Eleme.Common.Http,e={basketSyncSuccessTopic:"basketSyncSuccess",basketSyncErrorTopic:"baksetSyncError"};return a.prototype.init=function(){this.setDefaults()},a.prototype.setDefaults=function(){_.defaults(this.values,{isGarnish:!1,award:[]})},a.prototype.sync=function(a,b){var f=b.payload||{},g={increase:{url:"/cart/add",type:"get"},decrease:{url:"/cart/decrease",type:"get"},remove:{url:"/cart/delete",type:"get"},set:{url:"/cart/set",type:"get"}},h="//"+ELEME.mainHost+g[a].url+b.url,i=b.option,j=g[a].type;if(!h)throw new Error("invalid sync method");d.request({type:j,url:h,data:f,dataType:"jsonp"}).done(function(a){c.publish(e.basketSyncSuccessTopic,a,i)}).fail(function(a){c.publish(e.basketSyncErrorTopic,a)})},a.prototype.increase=function(a){this.sync("increase",{url:this._buildUrl(),payload:{num:1},option:a})},a.prototype.decrease=function(a){this.sync("decrease",{url:this._buildUrl(),payload:{num:-1},option:a})},a.prototype.remove=function(a){this.sync("remove",{url:this._buildUrl(),option:a})},a.prototype.set=function(a,b){this.sync("set",{url:this._buildUrl(),payload:{num:a},option:b})},a.prototype._buildUrl=function(){return"/"+this.values.groupId+"/"+(this.values.parentFoodId||0)+"/"+this.values.id},b=a}(),u=function(){"use strict";var a,b=function(a){{var b="",c=_.escape;Array.prototype.join}return b+='<div class="rcart-d-name">',a.isGarnish&&(b+='<i class="icon-rst-badge garnish"></i>'),b+=c(a.name)+'</div><div class="rcart-d-modify"><a class="rcart-d-act minus d_btn">-</a><input class="rcart-d-qty set_num_in" type="text" value="'+c(a.quantity)+'" /><a class="rcart-d-act add i_btn">+</a></div><div class="rcart-d-total symbol-rmb">'+c(a.price)+'</div><a class="rcart-d-del r_btn">&times;</a>'};return a=b}(),v=function(a){"use strict";function b(a,b){this.id=null,this.food=a,this.init(b)}var c,d=a,e=Eleme.Common.PubSub,f={numInputSelector:".set_num_in",removeBtnSelector:".r_btn"};return b.prototype.tagName="li",b.prototype.className="rcart-dish eleme_view",b.prototype.init=function(){this.id=this.food.values.isGarnish?"basketfood_view_"+this.food.values.id:"basketfood_garnish_view_"+this.food.values.id,Eleme.View.views[this.id]=this},b.prototype.$el=function(){return $("#"+this.id)},b.prototype.render=function(a){a.begin(this.tagName),a.setClass(this.className),a.setId(this.id),a.pushOpenTag(),a.push(d($.extend({},this.food.values))),a.pushCloseTag()},b.prototype.remove=function(){var a=this.$el().find(f.removeBtnSelector);a.hasClass("loading")||(a.addClass("loading"),e.subscribeOnce(f.basketSyncSuccessTopic,function(){a.removeClass("loading")},this),this.food.remove({basket:!0}))},b.prototype.increase=function(){this.food.increase({basket:!0})},b.prototype.decrease=function(){this.food.decrease({basket:!0})},b.prototype.set=function(){var a=this.$el().find(f.numInputSelector),b=window.parseInt(a.val(),10);this.food.set(b,{basket:!0})},b.prototype.toggleView=function(){this.$el().toggle()},b.prototype.destroy=function(){delete Eleme.View.views[this.id]},c=b}(u),w=function(a,b){"use strict";function c(a,b){this.id=null,this.basket=a,this.basketFoodViews=[],this.extraContent="",this.open=!1,this.init(b)}var d,e=a,f=b,g=Eleme.Common.Evt,h={emptyBasketHint:'<p class="rcart-empty">篮子是空的</p>',activitytemp:'<a class="rcart-activity" target="_black" href="http://ele.me/activity/xnbonus_2015" title="点击查看详情" style="display:none"></a>'},i=$(window);return $.extend(c.prototype,g),c.prototype.tagName="div",c.prototype.type="basket_view",c.prototype.className="rcart-list-wrapper eleme_view",c.prototype.init=function(){this.id=this.type+"_"+Eleme.View.uuid++,Eleme.View.views[this.id]=this,this.on("openChange",$.proxy(this.toggle,this)),this.generateViews()},c.prototype.$el=function(){return $("#"+this.id)},c.prototype.render=function(a){var b=this.basket.values.id+1,c=this.basket.values.foods;a.begin(this.tagName),this.addPropertyToBuffer(a),a.pushOpenTag(),c.length?(-1===$.inArray(ELEME.cityId,[35,38,42,49,50,53,66,68,81,97,105,114,119,124,127,131,135,139,143,156,157,165,173,177,220,223,243,278,286,30,73,199,219,64,72,182])&&a.push(h.activitytemp),a.push('<h4 class="rcart-title">'+b+'号篮子 <a class="rcart-clear basket_clear_btn">[清空]</a></h4>'),this.renderFoods(a)):a.push(h.emptyBasketHint),a.pushCloseTag()},c.prototype.addPropertyToBuffer=function(a){a.setId(this.id),a.setClass(this.className+" ui_c"+(this.basket.values.id+1))},c.prototype.generateViews=function(){var a,b,c,d,g,h,i,j=this.basket.values.foods;for(a=j.length;a--;)for(d=new e(j[a]),d.values.groupId=this.basket.values.id,h=new f(d),this.basketFoodViews.push(h),c=j[a].garnishes,b=c.length;b--;)g=new e(c[b]),g.values.isGarnish=!0,g.values.groupId=d.values.groupId,g.values.parentFoodId=d.values.id,i=new f(g),this.basketFoodViews.push(i)},c.prototype.renderFoods=function(a){var b,c,d=this.basketFoodViews;for(a.begin("ul"),a.setClass("rcart-list basket_list"),a.setStyle("max-height: "+(i.height()-205)+"px;"),a.pushOpenTag(),b=0,c=d.length;c>b;b++)d[b].render(a);this.extraContent&&a.push(this.extraContent),a.pushCloseTag()},c.prototype.findByFoodId=function(a){return _.find(this.basketFoodViews,function(b){return b.id===a})},c.prototype.sync=function(){this.basket.sync()},c.prototype.clearBasket=function(){this.basket.clear()},c.prototype.toggle=function(a){a=a||{};var b;this.open?(b=-this.$el().outerHeight(),this.$el().find(".rcart-activity").show(),a.anim?this.$el().animate({top:b},300):this.$el().css({top:b})):(this.$el().animate({top:"0px"},300),this.$el().find(".rcart-activity").hide())},c.prototype.remove=function(){this.$el().remove()},c.prototype.destroy=function(){delete Eleme.View.views[this.id],_.each(this.basketFoodViews,function(a){a.destroy()}),this.basketFoodViews.length=0},d=c}(t,v),x=function(){"use strict";var a,b=function(a){{var b,c="";_.escape}return c+='<div class="rcart-group"><a class="rcart-group-toggle switcher_toggle" data-toggle="bs-tooltip" title="展开篮子"></a><ul class="group basket_switcher">'+(null==(b=a.basketTiles)?"":b)+'</ul></div><div class="rcart-dock group basket_wrap">'+(null==(b=a.basketInfo)?"":b)+"</div>"+(null==(b=a.baskets)?"":b)};return a=b}(),y=function(){"use strict";var a,b=function(a){var b="",c=_.escape;return b+='<span class="rcart-info basket_food_info">'+c(a.num)+'份 <span class="symbol-rmb">'+c(a.price)+"</span></span>"};return a=b}(),z=function(){"use strict";var a,b=function(a){{var b="",c=_.escape;Array.prototype.join}return b+='<li class="rcart-dish"><div class="rcart-d-name">'+c(a.name)+"</div>",a.showNum&&(b+='<div class="rcart-d-modify">'+c(a.quantity)+"</div>"),b+='<div class="rcart-d-total symbol-rmb">'+c(a.price)+"</div></li>"};return a=b}(),A=function(){"use strict";var a,b=function(a){{var b,c="",d=_.escape;Array.prototype.join}return c+='<a class="rcart-checkout c_c ',a.isBtnDisabled&&(c+="disabled"),c+='" href="'+d(a.checkoutUrl)+'"',a.phoneOrder&&(c+=' data-toggle="bs-modal" data-target="#modal_phone"'),c+=">",a.phoneOrder&&(c+='<i class="glyph-tel"></i>'),c+=null==(b=a.btnHint)?"":b,a.checkoutReady&&(c+='<i class="glyph-bracket-right"></i>'),c+="</a>"};return a=b}(),B=function(){"use strict";var a,b=function(a){{var b="",c=_.escape;Array.prototype.join}return b+='<div id="modal_phone" class="bs-modal fade" tabindex="-1" role="dialog" aria-hidden="true"><div class="bs-modal-dialog rst-phone-modal"><div class="bs-modal-content"><a class="bs-close" data-dismiss="bs-modal" aria-hidden="true">&times;</a><div class="bs-modal-body basket_content"><p class="phrst-notice">该餐厅当前只支持电话订餐，请拨打餐厅电话</p><p class="phrst-tel">'+c(a.basketsInfo.phone)+'</p><article><header class="phrst-header group"><span class="phrst-name">'+c(a.basketsInfo.restaurantName)+'</span><span class="phrst-cost symbol-rmb">'+c(a.basketsInfo.total)+"</span></header>",_.each(a.baskets,function(a,d,e){b+='<div class="phrst-cart">',e.length>1&&(b+='<h5 class="cart-no">'+c(d+1)+"号篮子</h5>"),b+='<ul class="phrst-cart-list">',_.each(a,function(a){b+='<li class="phrst-cart-item"><span>'+c(a.name)+'</span><span class="quantity symbol-times">'+c(a.quantity)+'</span><span class="price symbol-rmb">'+c(a.price)+"</span></li>",_.each(a.garnishes,function(a){b+='<li class="phrst-cart-item"><span>'+c(a.name)+'</span><span class="quantity symbol-times">'+c(a.quantity)+'</span><span class="price symbol-rmb">'+c(a.price)+"</span></li>"})}),b+="</ul></div>"}),b+="</article></div></div></div></div>"};return a=b}(),C=function(a,b,c,d,e,f,g){"use strict";function h(a){this.$el=null,this.baskets=[],this.basketsInfo={},this.basketViews=[],this.currentBasket=0,this.isFirstFetch=!0,this.isCheckoutReady=!1,this.isCurrentViewOpen=!1,this.isSwitcherOpen=!1,this.init(a)}function i(a){var b=$(a.target),c=b.closest(".eleme_view").attr("id"),d=Eleme.View.views[c];return d}var j,k=a,l=b,m=c,n=d,o=e,p=f,q=g,r=Eleme.Common.Evt,s=Eleme.Common.Util,t=Eleme.Common.Http,u=Eleme.Common.PubSub,v=Eleme.Common.RenderBuffer,w={basketSelector:"#rst_cart",basketWrapSelector:".basket_wrap",basketSwitcherWrapSelector:".basket_switcher",basketSwitcherTipSelector:".switcher_toggle",basketTileSelector:".single_tile",currentBasketTileSelector:".current_basket_tile",cartCheckoutBtnSelector:".c_c",checkoutModalSelector:"#modal_phone",showMainFoodTopic:"showMainFood",addFoodTopic:"addFoodToBasket",basketSyncSuccessTopic:"basketSyncSuccess",basketSyncErrorTopic:"basketSyncError",getBasketInfoTopic:"getBasketInfo",addAnimEndTopic:"addAnimEnd",basketInitTopic:"basketInit",userInfoDoneTopic:"userInfoDone",basketTipTpl:"<%- data.basketId %>号篮子(<%- data.basketNum %>)",basketTileTpl:'<li class="rcart-no single_tile <%- data.tileClass %>" data-basketId="<%- data.basketId %>" data-toggle="bs-tooltip"><%- data.basketId %></li>',emptyBtnHint:"篮子是空的哦",reachLimitBtnHint:"去买单",unreachLimitBtnHint:'还差 <span class="symbol-rmb"><%- data.plus %></span> 起送',basketDefaultNum:6,basketClassPrefix:"ui_c",priceExtraList:[2,3,4,5,6,7,8,9,100,101]};return $.extend(h.prototype,r),h.prototype.init=function(){this.$el=$(w.basketSelector),this.subscribeTopic(),this.bindEvents(),this.on("switchChange",this.toggleBasketSwitcher,this)},h.prototype.subscribeTopic=function(){u.subscribe(w.userInfoDoneTopic,function(){this.fetch()},this),u.subscribe(w.getBasketInfoTopic,function(){return this.basketsInfo},this),u.subscribe(w.addFoodTopic,function(a,b){b=b||{},b.basketId=this.currentBasket,a.call(null,b)},this),u.subscribe(w.basketSyncSuccessTopic,function(a,b){b=b||{},"1"===a&&(a={quantity:0,total:0,groups:[],extras:[]});var c,d={};this.parseCartData(a),b.basket&&(this.clearPrevViews(),this.generateViews(),c=this.basketViews[this.currentBasket],this.render(),d.anim=this.isCurrentViewOpen?!1:!0,c.open=this.isCurrentViewOpen=!0,c.trigger("openChange",d),this.basketViews.length>1?this.trigger("switchChange",{anim:!1}):1===this.basketViews.length&&(this.isSwitcherOpen=!1))},this),u.subscribe(w.basketInitTopic,function(a){this.parseCartData(a),this.clearPrevViews(),this.generateViews(),this.render(),this.isFirstFetch=!1},this),u.subscribe(w.addAnimEndTopic,function(){this.clearPrevViews(),this.generateViews();var a={},b=this.basketViews[this.currentBasket];this.render(),a.anim=this.isCurrentViewOpen?!1:!0,b.open=this.isCurrentViewOpen=!0,b.trigger("openChange",a),this.basketViews.length>1?this.trigger("switchChange",{anim:!1}):1===this.basketViews.length&&(this.isSwitcherOpen=!1)},this),u.subscribe(w.basketSyncErrorTopic,function(){},this),u.subscribe(w.showMainFoodTopic,function(a){var b=this.baskets[this.currentBasket];a.call(null,this.currentBasket,b)},this)},h.prototype.bindEvents=function(){var a=this;this.$el.on("click",w.basketSwitcherTipSelector,function(){a.isSwitcherOpen=!a.isSwitcherOpen,a.trigger("switchChange",{anim:!0}),ga("send","event","restaurant","basketSwitcher",a.isSwitcherOpen?"open":"close")}),this.$el.on("click",w.cartCheckoutBtnSelector,function(b){a.isCheckoutReady?(a.basketsInfo.phoneOrder&&(b.preventDefault(),a.openCheckoutModal()),ga("send","event","checkoutOrigin",ELEME.route)):b.preventDefault(),b.stopPropagation()}),this.$el.on("click",w.basketWrapSelector,function(){var b=a.basketViews[a.currentBasket];b.open=a.isCurrentViewOpen=!b.open,b.trigger("openChange",{anim:!0})}),this.$el.on("mouseenter",w.basketSwitcherTipSelector,function(){var a=$(this).parent().hasClass("ui_open")?"关闭篮子":"展开篮子";$(this).attr("data-original-title",a)}),this.$el.on("mouseenter",w.basketTileSelector,function(){var b,c,d,e,f,g=0,h=$(this).data("basketid"),i=a.baskets[h-1],j=_.template(w.basketTipTpl);for(b=i.length;b--;)for(d=i[b],g+=d.quantity,c=d.garnishes.length;c--;)e=d.garnishes[c],g+=e.quantity;f=j({basketId:h,basketNum:g}),$(this).attr("data-original-title",f)}),this.$el.on("click",w.basketTileSelector,function(b){var c=$(b.target).data("basketid");ga("send","event","restaurant","basketChange",c),c-=1,a.switchBasket(c)}),this.$el.on("mouseenter",w.basketWrapSelector,function(){0!==a.baskets[0].length&&a.$el.find(w.basketSwitcherTipSelector).show()}),this.$el.on("mouseleave",w.basketWrapSelector,function(b){$(b.relatedTarget).hasClass(w.basketSwitcherTipSelector.substr(1))||a.$el.find(w.basketSwitcherWrapSelector).parent().hasClass("ui_open")||a.$el.find(w.basketSwitcherTipSelector).hide()}),this.$el.on("mouseleave",w.basketSwitcherTipSelector,function(b){var c=$(b.target);a.$el.find(w.basketSwitcherWrapSelector).parent().hasClass("ui_open")||c.hide()}),$(window).on("resize",function(){var a=$(window).height(),b=$(".single_basket.ui_open");if($(window).height()>250&&($(".single_basket").css("max-height",a-155),b.length)){var c=b.find(".basket_list").outerHeight();b.css("top",c>a-155?155-a:-c)}}),this.$el.on("click",".basket_clear_btn",function(a){i(a).clearBasket()}),this.$el.on("click",".i_btn",function(a){i(a).increase()}),this.$el.on("click",".d_btn",function(a){i(a).decrease()}),this.$el.on("click",".r_btn",function(a){i(a).remove()}),this.$el.on("change",".set_num_in",function(a){i(a).set()}),this.$el.tooltip({selector:'[data-toggle="bs-tooltip"]',animation:!1,placement:"top",delay:{show:700,hide:0},container:"body"})},h.prototype.fetch=function(a){this.sync("fetch",{option:a})},h.prototype.parseCartData=function(a){this.basketsInfo=$.extend(!0,{},a),this.baskets=this.basketsInfo.groups,this.baskets.length<w.basketDefaultNum&&this.baskets.push([])},h.prototype.render=function(){var a="",b={};b.basketInfo=this.renderBasketInfo(),b.basketTiles=this.renderTile(),b.baskets=this.renderBasket(),a=m(b),this.$el.empty().html(a)},h.prototype.rerenderBasket=function(){},h.prototype.clearPrevViews=function(){_.each(this.basketViews,function(a){a.destroy()}),this.basketViews.length=0},h.prototype.generateViews=function(){var a,b,c,d;for(a=0,b=this.baskets.length;b>a;a++)c=new k({id:a,foods:this.baskets[a]}),d=new l(c),0===a&&(d.extraContent=this.makeExtraContent()),this.basketViews.push(d)},h.prototype.renderBasketInfo=function(){var a,b,c=this.currentBasket+1,d=!1,e=!1,f=new v;return f.push('<i class="icon-rcart glyph-cart cart1 current_basket_tile ui_c'+c+'"></i>'),this.isCheckoutReady=!1,0===this.basketsInfo.total&&0===this.basketsInfo.quantity?(a=w.emptyBtnHint,e=!0):(f.push(n({num:this.basketsInfo.quantity,price:this.basketsInfo.total})),this.basketsInfo.total>=0&&this.basketsInfo.deliverAmount<this.basketsInfo.restaurantDeliverAmount?(a=_.template(w.unreachLimitBtnHint,{plus:s.add(this.basketsInfo.restaurantDeliverAmount,-this.basketsInfo.deliverAmount)}),e=!0):this.basketsInfo.deliverAmount>=this.basketsInfo.restaurantDeliverAmount&&(a=w.reachLimitBtnHint,d=!0,this.isCheckoutReady=!0)),b={btnHint:a,isBtnDisabled:e,checkoutReady:d,phoneOrder:this.basketsInfo.phoneOrder,checkoutUrl:"http://"+ELEME.mainHost+"/cart/checkout"},f.push(p(b)),f.buffer},h.prototype.renderBasket=function(){var a,b,c=new v;for(a=0,b=this.basketViews.length;b>a;a++)this.basketViews[a].render(c);return c.buffer},h.prototype.makeExtraContent=function(){var a,b,c,d="",e=this.basketsInfo.extras;for(a=0,b=e.length;b>a;a++)(c=e[a])&&(c.showNum=_.contains(w.priceExtraList,c.category_id)?!1:!0,d+=o(c));return d},h.prototype.renderTile=function(){var a,b,c="",d=_.template(w.basketTileTpl),e=new v;for(a=this.baskets.length;a--;)b=0===this.baskets[a].length?w.basketClassPrefix+(a+1)+" empty":w.basketClassPrefix+(a+1),c+=d({basketId:a+1,tileClass:b,basketNum:this.baskets[a].length});return e.push(c),e.buffer},h.prototype.toggleBasketSwitcher=function(a){a=a||{};var b=this.$el.find(w.basketTileSelector).width(),c=this.$el.find(w.basketSwitcherWrapSelector).parent();this.isSwitcherOpen?a.anim?c.addClass("ui_open").animate({left:-b*this.baskets.length},500):c.addClass("ui_open").css("left",-b*this.baskets.length):(a.anim?c.removeClass("ui_open").animate({left:0},500):c.removeClass("ui_open").css("left",0),this.$el.find(w.basketSwitcherTipSelector).hide())},h.prototype.switchBasket=function(a){var b=this.currentBasket,c=this.$el.find(w.currentBasketTileSelector);a!==this.currentBasket&&(this.currentBasket=a,c.removeClass(w.basketClassPrefix+(b+1)).addClass(w.basketClassPrefix+(this.currentBasket+1)),this.basketViews[b].open=!1,this.basketViews[b].trigger("openChange",{anim:!0}),this.basketViews[this.currentBasket].open=!0,this.basketViews[this.currentBasket].trigger("openChange",{anim:!0}))},h.prototype.openCheckoutModal=function(){var a,b=this.baskets.slice(),c=$(w.checkoutModalSelector);b.pop(),a=q({basketsInfo:this.basketsInfo,baskets:b}),c.length>0?c.replaceWith(a):$("body").append(a),c=$(w.checkoutModalSelector),c.modal("show")},h.prototype.sync=function(a,b){var c={fetch:{url:"/cart",type:"get"}},d="//"+ELEME.mainHost+c[a].url,e=c[a].type;t.request({type:e,url:d,data:b,dataType:"jsonp"}).done(function(b){"fetch"===a?u.publish(w.basketInitTopic,b):u.publish(w.basketSyncSuccessTopic,b)}).fail(function(){})},j=h}(s,w,x,y,z,A,B),D=function(){"use strict";function a(a){this.values=a||{},this.events={},this.init()}var b,c=Eleme.Common.Evt,d=Eleme.Common.Http;return $.extend(a.prototype,c),a.prototype.init=function(){this.setDefaults()},a.prototype.setDefaults=function(){_.defaults(this.values,{favored:!1,distance:"",deliver_amount:0})},a.prototype.favor=function(){this.sync("favor",{}).then($.proxy(this.favorHandler,this))},a.prototype.unFavor=function(){this.sync("unfavor",{}).then($.proxy(this.unFavorHandler,this))},a.prototype.favorHandler=function(a){a.success&&(this.values.favored=!0,this.trigger("favorStateChange"))},a.prototype.unFavorHandler=function(a){a.success&&(this.values.favored=!1,this.trigger("favorStateChange"))},a.prototype.sync=function(a,b){var c,e,f=b||{},g={favor:{url:"/favor",type:"post"},unfavor:{url:"/unfavor",type:"post"}};return e=g[a].type,c="//"+window.location.host+ELEME.baseUrl+"/"+ELEME.restaurantUrl+g[a].url,d.request({type:e,url:c,data:f})},b=a}(),E=function(){"use strict";var a,b=function(a){var b="",c=_.escape;return b+='<a class="btn-last-page" href="'+c(a.backUrl)+'"><i class="glyph-back"></i>返回</a>'};return a=b}(),F=function(a,b){"use strict";function c(){this.restaurant=new e,this.init()}var d,e=a,f=b,g=Eleme.Common.Evt,h=Eleme.Common.Http,i=Eleme.Common.PubSub,j={headerWrapSelector:".rst_header_con",favorBtnSelector:"#rst_fav",mapSelector:".rst_map",restaurantDeliverAmountSelector:".rst_deliver_amount",restaurantInfoPanelSelector:".rst_info_panel",headDistanceSelector:".rst_head_distance",restaurantDistanceSelector:".rst_distance",restaurantInfoDoneTopic:"restaurantInfoDone",userInfoDoneTopic:"userInfoDone",openLoginPanelTopic:"openLoginPanel",userInfoUrl:"/"+ELEME.restaurantUrl+"/userinfo"};return $.extend(c.prototype,g),c.prototype.init=function(){this.$el=$(j.headerWrapSelector),this.listenTo(this.restaurant,"favorStateChange",$.proxy(this.favorStateHandler,this)),this.bindEvents(),this.subscribeTopic()},c.prototype.bindEvents=function(){var a=this;this.$el.on("click",j.favorBtnSelector,function(){ELEME.authed?a.restaurant.values.favored?a.restaurant.unFavor():a.restaurant.favor():i.publish(j.openLoginPanelTopic)}),this.$el.on("click",j.favorBtnSelector,function(){ga("send","event","restaurant","favorRestaurant")})},c.prototype.subscribeTopic=function(){i.subscribeOnce(j.restaurantInfoDoneTopic,function(a){this.updateRestaurantInfo(a)},this),i.subscribeOnce(j.userInfoDoneTopic,function(a){this.fetchRstInfo(),this.addBackIcon(a.geohash)},this)},c.prototype.fetchRstInfo=function(){var a=ELEME.baseUrl+j.userInfoUrl;h.request({type:"get",url:a,cache:!1}).done(function(a){i.publish(j.restaurantInfoDoneTopic,a)}).fail(function(){})},c.prototype.updateRestaurantInfo=function(a){this.restaurant.values=a,this.restaurant.values.distance?this.$el.find(j.restaurantDistanceSelector).html(this.restaurant.values.distance):this.$el.find(j.headDistanceSelector).addClass("hide"),this.$el.find(j.mapSelector).attr("src",a.mapUrl),this.$el.find(j.restaurantDeliverAmountSelector).html(this.restaurant.values.deliverAmount),this.$el.find(j.restaurantInfoPanelSelector).show(),this.favorStateHandler()},c.prototype.addBackIcon=function(a){var b;b=a?ELEME.isRestaurantPremium?"http://"+ELEME.rootHost+"/premium/geohash/"+a:"http://"+ELEME.rootHost+"/place/"+a:"http://"+ELEME.rootHost,this.$el.prepend(f({backUrl:b}))},c.prototype.favorStateHandler=function(){var a,b=this.$el.find(j.favorBtnSelector),c=b.find("span");this.restaurant.values.favored?(a=c.data("faved"),b.addClass("ui_faved"),c.text(a)):(a=c.data("unfaved"),b.removeClass("ui_faved"),c.text(a))},d=c}(D,E),G=function(){"use strict";function a(){this.$el=null,this.active=!1,this.init()}var b,c=Eleme.Common.PubSub,d={loginModalSelector:"#modal_iLogin",iframeSelector:".login_frame",openLoginPanelTopic:"openLoginPanel"};return a.prototype.init=function(){this.$el=$(d.loginModalSelector),this.bindEvents(),this.subscribeTopic()},a.prototype.bindEvents=function(){this.$el.on("hidden.bs.modal",$.proxy(this.hide,this)),this.$el.on("shown.bs.modal",$.proxy(this.setPage,this)),$(window).on("message.login",$.proxy(this.handleMsg,this));

},a.prototype.subscribeTopic=function(){c.subscribe(d.openLoginPanelTopic,function(){this.open()},this)},a.prototype.open=function(){this.$el.modal("show")},a.prototype.hide=function(){this.active=!1},a.prototype.setPage=function(){var a=this.$el.find(d.iframeSelector),b=this.getPageUrl();a.attr("src",b)},a.prototype.getPageUrl=function(){return"https://account."+ELEME.rootHost+ELEME.baseUrl+"/ilogin"},a.prototype.handleMsg=function(a){var b=a.originalEvent.origin,c=a.originalEvent.data;b==="https://account."+ELEME.rootHost&&"string"==typeof c&&(c=JSON.parse(c),c.success&&this.handleSuccess())},a.prototype.handleSuccess=function(){window.location.reload(!0)},b=a}();!function(a,b,c,d,e){"use strict";var f=a,g=b,h=c,i=d,j=e;Eleme.View={views:{},uuid:0};new f,new g,new h,new i,new j;$(document).ready(function(){$("img[srcset]").srcset()})}(l,r,C,F,G)}();