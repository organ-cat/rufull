!function(){var a=function(){"use strict";function a(){}var b,c={maskSelector:"#cart_mask",panelSelector:".checkout_panel"};return a.prototype.showPanel=function(){$(c.maskSelector).fadeIn(200),this.$el.find(c.panelSelector).fadeIn(200)},a.prototype.hidePanel=function(){this.hideAlert(),$(c.maskSelector).fadeOut(200),this.$el.find(c.panelSelector).fadeOut(200)},a.prototype.hideAlert=function(a){a=a||this.$el,a.find(".error_tip").remove()},a.prototype.storeContent=function(a,b){if(a)if("object"!=typeof a||"undefined"!=typeof b)null!==b&&"undefined"!=typeof b&&window.localStorage.setItem(a,b);else for(var c in a)this.storeContent(c,a[c])},a.prototype.fetchContent=function(a){return a?window.localStorage.getItem(a):void 0},a.prototype.validate=function(){return!0},a.prototype.fillForm=function(){this.formInputSelector&&$(this.formInputSelector).val(this.formContent)},a.prototype.saveCheckoutInfo=function(){this.storeContent(this.tempDataKey,this.formContent)},a.prototype.clearTempData=function(){if(this.tempDataKey)if($.isArray(this.tempDataKey))for(var a=this.tempDataKey.length;a--;)window.localStorage.removeItem(this.tempDataKey[a]);else window.localStorage.removeItem(this.tempDataKey)},b=a}(),b=function(a){"use strict";function b(){this.$el=null,this.formContent="",this.formInputSelector=h.formInputSelector,this.init()}function c(a){var b,c,d;return a=a.replace(/1\d{16}/,"").replace(/\s+/g,""),(c=a.match(/(\d+)/g))?(b=_.filter(c,function(a){return g.test(a)||f.test(a)}),d=c.join(""),b.length||g.test(d)||f.test(d)?void 0:!0):!0}var d,e=a,f=Eleme.Common.Regex.fulltel,g=Eleme.Common.Regex.cellphone,h={noteContainerSelector:"#module_note",noteTextSelector:"#c_n_text",notePanelSelector:"#n_p",noteItemSelector:".c_n_i",formInputSelector:"#value_note",noteErrTip:"请不要在餐厅留言处填写电话信息"};return $.extend(b.prototype,e.prototype),b.prototype.init=function(){this.$el=$(h.noteContainerSelector),this.bindEvents()},b.prototype.bindEvents=function(){var a=this;this.$el.on("click",h.noteItemSelector,function(b){b.stopPropagation();var c=$(b.target);a.addToTextInput(c.text())}),this.$el.on("click",h.noteTextSelector,function(b){b.stopPropagation(),a.showPanel()}),this.$el.on("keyup",h.noteTextSelector,$.proxy(this.updateNote,this)),$(document).on("click",function(){a.hidePanel()})},b.prototype.addToTextInput=function(a){var b="",c=this.$el.find(h.noteTextSelector),d=c.val();-1===d.indexOf(a)&&(b=""===d?a:$.trim(d)+" "+a,c.val(b),this.formContent=b)},b.prototype.updateNote=function(a){var b=$(a.target),d=$.trim(b.val());this.formContent=d,c(d)?this.hideAlert():(this.hidePanel(),this.$el.find(h.noteTextSelector).showAlertTip(h.noteErrTip)),13===a.which&&this.hidePanel()},b.prototype.showPanel=function(){this.$el.find(h.notePanelSelector).removeClass("hide")},b.prototype.hidePanel=function(){this.$el.find(h.notePanelSelector).addClass("hide")},b.prototype.validate=function(){return c(this.formContent)?!0:(this.$el.find(h.noteTextSelector).showAlertTip(h.noteErrTip),!1)},d=b}(a),c=function(a){"use strict";function b(){this.$el=null,this.couponValidated=!1,this.formContent="",this.init()}var c,d=a,e=Eleme.Common.PubSub,f=Eleme.Common.Http,g={couponWrapSelector:"#module_cpn",cpnTextSelector:"#c_c_b",panelSelector:".checkout_panel",cancelBtnSelector:"#cpn_cancel",confirmBtnSelector:"#cpn_confirm",cpnInputSelector:"#cpn_text",maskSelector:"#cart_mask",handleCouponTopic:"handleCoupon",handleCouponErrorTopic:"handleCouponError",emptyCouponTip:"请填写优惠券",couponValidateUrl:"/cart/coupon/"};return $.extend(b.prototype,d.prototype),b.prototype.init=function(){this.$el=$(g.couponWrapSelector),this.bindEvents(),this.subscribeTopic()},b.prototype.bindEvents=function(){var a=this;this.$el.on("click",g.cpnTextSelector,$.proxy(this.showPanel,this)),this.$el.on("click",g.cancelBtnSelector,$.proxy(this.hidePanel,this)),this.$el.on("keyup",g.cpnInputSelector,$.proxy(this.updateCoupon,this)),this.$el.on("focus",g.cpnInputSelector,function(){a.hideAlert()}),this.$el.on("click",g.confirmBtnSelector,$.proxy(this.validateCoupon,this)),$(g.maskSelector).on("click",$.proxy(this.hidePanel,this))},b.prototype.subscribeTopic=function(){e.subscribe(g.handleCouponTopic,function(){this.couponValidated=!0,this.hidePanel(),this.$el.find(g.cpnInputSelector).val("")},this),e.subscribe(g.handleCouponErrorTopic,function(a){this.$el.find(g.cpnInputSelector).val(""),this.formContent="",this.$el.find(g.cpnInputSelector).parent().showAlertTip(a.msg)},this)},b.prototype.updateCoupon=function(a){this.formContent=$(a.target).val(),13===a.which&&this.validateCoupon()},b.prototype.validateCoupon=function(){if(""===this.formContent)return void this.$el.find(g.cpnInputSelector).parent().showAlertTip(g.emptyCouponTip);var a={},b="http://"+ELEME.mainHost+g.couponValidateUrl+this.formContent;f.request({type:"get",url:b,data:a}).done(function(a){e.publish(g.handleCouponTopic,a)}).fail(function(a){e.publish(g.handleCouponErrorTopic,a)})},c=b}(a),d=function(){"use strict";var a,b=function(a){{var b,c="",d=_.escape;Array.prototype.join}return c+='<div id="main_food_panel" class="cgarnish-dropdown"><p class="helper">添加到以下菜品中</p>',_.each(a,function(e,f){c+='<div class="cgarnish-basket-group ui_c'+(null==(b=f+1)?"":b)+' food_group" data-group="'+(null==(b=f)?"":b)+'">',a.length>1&&(c+='<h5 class="number">'+(null==(b=f+1)?"":b)+"号篮子</h5>"),_.each(e,function(a){c+='<a class="dish single_main_food" title="'+d(a.name)+'" data-id="'+(null==(b=a.id)?"":b)+'">'+d(a.name)+"</a>"}),c+="</div>"}),c+="</div>"};return a=b}(),e=function(a){"use strict";function b(){this.$el=null,this.mainFood=[],this.mainFoodContent="",this.collapsed=!0,this.events={},this.init()}var c,d=a,e=Eleme.Common.Evt,f=Eleme.Common.Http,g=Eleme.Common.PubSub,h={garnishWrapSelector:"#module_gns",mainFoodSelector:".single_main_food",mainFoodDropSelector:".add_main_btn",mainFoodPanelSelector:"#main_food_panel",mainBtnSelector:".add_btn",garnishContainerSelector:".gns_container",toggleContainerSelector:".toggle_btn",basketSyncSuccessTopic:"basketSyncSuccess",addFoodUrl:"/cart/add/",cartUrl:"/cart"};return $.extend(b.prototype,e),b.prototype.init=function(){this.$el=$(h.garnishWrapSelector),this.bindEvents(),this.subscribeTopic(),this.getMainFoodData(),this.on("toggle",$.proxy(this.togglePanel,this))},b.prototype.bindEvents=function(){var a=this;$(document).on("click",function(){var b=a.$el.find(h.mainFoodPanelSelector);b.parent().removeClass("ui_open"),b.remove()}),this.$el.on("click",h.mainFoodDropSelector,function(b){var c=$(b.target),d=a.$el.find(h.mainFoodPanelSelector);return c.parent().hasClass("ui_open")?(c.parent().removeClass("ui_open"),void d.remove()):(d.parent().removeClass("ui_open"),d.remove(),""===a.mainFoodContent&&(a.mainFoodContent=a.buildMainFoodContent()),c.after(a.mainFoodContent).parent().addClass("ui_open"),!1)}),this.$el.on("click",h.mainBtnSelector,function(b){var c=$(b.target),d=c.parent().data("foodid");a.addFood({foodId:d})}),this.$el.on("click",h.mainFoodSelector,function(b){var c=$(b.target),d=c.closest(".gns_row").data("foodid"),e=c.data("id"),f=c.closest(".food_group").data("group");a.addFood({foodId:d,groupId:f,parentId:e})}),this.$el.on("click",h.toggleContainerSelector,function(){return a.trigger("toggle"),!1})},b.prototype.subscribeTopic=function(){g.subscribe(h.basketSyncSuccessTopic,function(a){this.mainFood=a.groups,this.mainFoodContent=this.buildMainFoodContent()},this)},b.prototype.togglePanel=function(){this.collapsed?this.showPanel():this.hidePanel()},b.prototype.showPanel=function(){var a=this;this.$el.find(h.garnishContainerSelector).slideDown(function(){a.collapsed=!a.collapsed,a.$el.closest("#module_basket").addClass("ui_open")})},b.prototype.hidePanel=function(){var a=this;this.$el.find(h.garnishContainerSelector).slideUp(function(){a.collapsed=!a.collapsed,a.$el.closest("#module_basket").removeClass("ui_open")})},b.prototype.addFood=function(a){var b,c=a.foodId,d=a.parentId||0,e=a.groupId||0,i={num:1};c&&(b="http://"+ELEME.mainHost+h.addFoodUrl+[e,d,c].join("/"),f.request({url:b,type:"get",dataType:"jsonp",data:i}).done(function(a){g.publish(h.basketSyncSuccessTopic,a)}).fail(function(){}))},b.prototype.buildMainFoodContent=function(){return d(this.mainFood)},b.prototype.getMainFoodData=function(){var a=this,b="http://"+ELEME.mainHost+h.cartUrl;f.request({url:b,type:"get"}).done(function(b){a.mainFood=b.groups}).fail(function(){})},c=b}(d),f=function(a){"use strict";function b(){this.$el=null,this.name="invoice",this.freeze=!0,this.invMinAmount=0,this.needInvoice=!1,this.formInputSelector=h.formInputSelector,this.formContent="",this.activeInvoiceTitle="",this.tempDataKey="checkout_inv",this.init()}var c,d=a,e=Eleme.Common.Evt,f=Eleme.Common.PubSub,g=Eleme.Common.Http,h={invWrapSeletor:"#module_inv",invInnerWrapSelector:"#module_invoice",cancelBtnSelector:".cancel_btn",confirmBtnSelector:".confirm_btn",invTitleSelector:"#inv_text",needInvSelector:"#need_inv",notNeedInvSelector:"#no_need_inv",noInvWrapSelector:".no_inv_wrap",needInvWrapSelector:".need_inv_wrap",invInfoSelector:"#inv_info",delInvSelector:".del_btn",singleInvSelector:".single_inv",formInputSelector:"#value_inv",maskSelector:"#cart_mask",basketSyncSuccessTopic:"basketSyncSuccess",errTip:"请填写发票抬头",noInvoiceTip:"不需要发票"};return $.extend(b.prototype,d.prototype,e),b.prototype.init=function(){var a=this.fetchContent(this.tempDataKey);this.invMinAmount=$("#restaurant").data("inv"),this.$el=$(h.invWrapSeletor),this.subscribeTopic(),this.bindEvents(),this.on("invChange",$.proxy(this.changeStyle,this)),this.on("freezeChange",$.proxy(this.toggleFreezeState,this)),this.$el.hasClass("hide")||(this.freeze=!1),a&&(this.formContent=a,this.updateInvoice())},b.prototype.subscribeTopic=function(){f.subscribe(h.basketSyncSuccessTopic,function(a){a.deliverAmount>=this.invMinAmount?(this.freeze=!1,this.trigger("freezeChange")):(this.freeze=!0,this.trigger("freezeChange"))},this)},b.prototype.bindEvents=function(){var a=this;this.$el.on("click",h.invInnerWrapSelector,$.proxy(this.showPanel,this)),this.$el.on("click",h.cancelBtnSelector,$.proxy(this.hidePanel,this)),this.$el.on("click",h.confirmBtnSelector,$.proxy(this.saveInvoiceInfo,this)),this.$el.on("click",h.needInvSelector,function(){a.needInvoice||(a.needInvoice=!0,a.trigger("invChange"))}),this.$el.on("click",h.notNeedInvSelector,function(){a.needInvoice&&(a.needInvoice=!1,a.trigger("invChange"))}),this.$el.on("focus",h.invTitleSelector,function(){a.hideAlert(),a.needInvoice||a.$el.find(h.needInvSelector).trigger("click")}),this.$el.on("keyup",h.invTitleSelector,function(b){var c=$(b.target);a.activeInvoiceTitle=c.val()}),this.$el.on("click",h.singleInvSelector,function(){var b=$(this).find(".inv_title").text();a.selectInv(b)}),this.$el.on("click",h.delInvSelector,function(b){var c=$(b.target),d=c.parent(h.singleInvSelector);return a.removeInvoice(d),!1}),$(h.maskSelector).on("click",$.proxy(this.hidePanel,this))},b.prototype.toggleFreezeState=function(){this.freeze?(this.$el.addClass("hide"),this.$el.find(h.invInfoSelector)):this.$el.removeClass("hide")},b.prototype.changeStyle=function(){var a=this.$el.find(this.needInvoice?h.needInvWrapSelector:h.noInvWrapSelector);a.addClass("ui_current").siblings().removeClass("ui_current")},b.prototype.selectInv=function(a){this.$el.find(h.invTitleSelector).val(a),this.activeInvoiceTitle=a,this.$el.find(h.needInvSelector).trigger("click")},b.prototype.saveInvoiceInfo=function(){if(this.formContent=this.activeInvoiceTitle,this.needInvoice){if(""===this.formContent)return void this.$el.find(h.invTitleSelector).showAlertTip(h.errTip);this.storeContent(this.tempDataKey,this.formContent)}else{this.formContent=this.activeInvoiceTitle="",this.$el.find(h.invTitleSelector).val("");try{window.localStorage.removeItem(this.tempDataKey)}catch(a){}}this.updateInvoice(),this.hidePanel()},b.prototype.updateInvoice=function(){var a=this.formContent||h.noInvoiceTip;this.$el.find(h.invInfoSelector).text(a)},b.prototype.fillForm=function(){this.freeze||$(this.formInputSelector).val(this.formContent)},b.prototype.storeInfo=function(){this.storeContent("last_invoice",this.formContent)},b.prototype.removeInvoice=function(a){var b,c=this,d={},e=a.data("id");b="http://"+ELEME.mainHost+"/invoice/"+e,g.request({type:"delete",url:b,data:d}).done(function(){c.$el.find('[data-id="'+e+'"]').remove()}).fail(function(){})},c=b}(a),g=function(){"use strict";var a,b=function(a){var b="",c=_.escape;return b+='<span class="cmodule-info current_addr">'+c(a.name)+" "+c(a.address)+" "+c(a.tel)+" "+c(a.bakTel)+"</span>"};return a=b}(),h=function(){"use strict";var a,b=function(a){{var b,c="";_.escape}return c+='<div id="new_user_discount" class="ui-tip-notice success">新用户享受'+(null==(b=a.newUserDiscount)?"":b)+"元优惠</div>"};return a=b}(),i=function(a,b,c){"use strict";function d(a){this.isCreating=!1,this.controller=a,this.$el=null,this.activeAddr=null,this.tempDataKey=["checkout_name","checkout_addr","checkout_tel","checkout_bak_tel"],this.childViews=[],this.init()}function e(a){this.isLoading=this.isEditing=this.isCurrent=!1,this.$el=$(a),this.id=this.$el.data("id"),this.events={},this.init()}function f(a){var b=a||{},c="http://"+ELEME.mainHost+"/cart/phone/check";return l.request({url:c,type:"get",data:b,cache:!1})}var g={},h=a,i=b,j=c,k=Eleme.Common.Evt,l=Eleme.Common.Http,m=Eleme.Common.PubSub,n=Eleme.Common.Regex.tel,o=Eleme.Common.Regex.cellphone,p={addressWrapSelector:"#module_addr",addrInnerWrapSelector:"#module_address",singleAddressSelector:".single_addr",cancelBtnSelector:".cancel_btn",confirmBtnSelector:".confirm_btn",addrInfoSelector:".current_addr",rowAddrUserSelector:".row_name",rowAddrNameSelector:".row_addr",rowAddrTelSelector:".row_tel",rowAddrBakTelSelector:".row_bak_tel",rowAddrRadioSelector:".row_radio",editAddrUserSelector:".row_name_edit",editAddrNameSelector:".row_addr_edit",editTelSelector:".row_tel_edit",editBakTelSelector:".row_baktel_edit",editBtnSelector:".edit_btn",editCancelBtnSelector:".edit_cancel_btn",editSaveBtnSelector:".edit_update_btn",editLoaderSelector:".edit_save_loader",deleteBtnSelector:".del_btn",nameInputSelector:"#value_name",addressInputSelector:"#value_addr",telInputSelector:"#value_tel",bakTelInputSelector:"#value_tel_bk",newAddrTextSelector:"#new_addr_text",newAddrSelector:"#new_addr",cancelNewBtnSelector:".cancel_new_btn",maskSelector:"#cart_mask",newUserTipSelector:"#new_user_discount",telErrTip:"请填写11位手机号码",phoneErrTip:"请填写手机号码，手机短号，固定电话(电话号码-分机号码)",nameErrTip:"请填写收外卖人的姓名",addrErrTip:"请填写地址",emptyAddrTip:"请正确填写外卖人的姓名、送达地址与手机号",newUserTopic:"newUser",checkUserTopic:"checkUser",onlinePaymentDiscount:"onlinePaymentDiscount"};return $.extend(d.prototype,h.prototype,k),d.prototype.init=function(){this.$el=$(p.addressWrapSelector),this.addChildView(),this.on("createChange",$.proxy(this.toggleCreate,this)),this.bindEvents(),this.childViews.length||(this.isCreating=!0),this.updateCurrentAddr()},d.prototype.getNote=function(){return $.trim($("#c_n_text").val())},d.prototype.getInvoice=function(){var a=!0;return this.controller.checkoutViews[3]&&"invoice"===this.controller.checkoutViews[3].name?(a=this.controller.checkoutViews[3].freeze,a||"不需要发票"===$("#inv_info").text()?"":$("#inv_info").text()):""},d.prototype.bindEvents=function(){var a=this;this.$el.on("click",p.addrInnerWrapSelector,$.proxy(this.showPanel,this)),this.$el.on("click",p.cancelBtnSelector,function(){a.hideAlert(),a.hidePanel()}),this.$el.on("click",p.editBtnSelector,function(b){b.preventDefault();var c=$(this).closest(p.singleAddressSelector);a.enterEdit(c.data("id"))}),this.$el.on("click",p.editCancelBtnSelector,function(b){var c=$(b.target),d=c.closest(p.singleAddressSelector);a.cancelEdit(d)}),this.$el.on("click",p.confirmBtnSelector,$.proxy(this.saveAddress,this)),this.$el.on("click",p.editSaveBtnSelector,function(b){var c=$(b.target),d=c.closest(p.singleAddressSelector);a.updateAddress(d)}),this.$el.on("click",p.deleteBtnSelector,function(){var b=$(this).closest(p.singleAddressSelector);a.deleteAddress(b.data("id"))}),this.$el.on("click",p.rowAddrRadioSelector,function(b){var c=$(b.target).closest(p.singleAddressSelector).data("id");a.isCreating&&(a.isCreating=!1,a.trigger("createChange")),a.switchCurrentAddr(c)}),this.$el.on("click",p.newAddrTextSelector,$.proxy(this.newAddrEdit,this)),this.$el.on("click",p.cancelNewBtnSelector,function(){a.hideAlert(a.$el.find(p.newAddrSelector)),a.childViews.length?(a.isCreating=!1,a.trigger("createChange"),a.childViews[0].setupCurrent()):a.$el.find("input").val("")}),this.$el.on("focus",p.editAddrUserSelector,function(){$(this).prev(".error_tip").remove()}),this.$el.on("focus",p.editAddrNameSelector,function(){$(this).prev(".error_tip").remove()}),this.$el.on("focus",p.editTelSelector,function(){$(this).prev(".error_tip").remove()}),$(p.maskSelector).on("click",$.proxy(this.hidePanel,this))},d.prototype.newAddrEdit=function(){var a=this.findCurrentAddr();this.cancelEdit(),this.isCreating||(this.isCreating=!0,this.trigger("createChange"),a&&a.cancelCurrent())},d.prototype.toggleCreate=function(){var a=this.$el.find(p.newAddrSelector);this.isCreating?(a.addClass("ui_current").removeClass("hide").find("#addr_new_radio").prop("checked",!0),a.find(p.editAddrUserSelector).select()):a.removeClass("ui_current").addClass("hide").find("input").val("")},d.prototype.updateCurrentAddr=function(){var a;return this.childViews.length?(a=_.find(this.childViews,function(a){return a.isCurrent}),void(a&&(this.activeAddr={id:a.id,name:a.$el.find(p.rowAddrUserSelector).text(),address:a.$el.find(p.rowAddrNameSelector).text(),tel:a.$el.find(p.rowAddrTelSelector).text(),bakTel:a.$el.find(p.rowAddrBakTelSelector).text()},m.publish(p.checkUserTopic,{phone:this.activeAddr.tel,phone_bk:this.activeAddr.bakTel,address:this.activeAddr.address,order_note:this.getNote(),invoice:this.getInvoice()})))):(this.fetchAddr(this.tempDataKey)||this.fetchAddr(["checkout_name","last_addr","last_tel","last_bak_tel"]),void(this.activeAddr&&(f({phone:this.activeAddr.tel,phone_bk:this.activeAddr.bakTel,address:this.activeAddr.address}).then(function(a){m.publish(p.onlinePaymentDiscount,a.onlinePaymentDiscount)}),m.publish(p.checkUserTopic,{phone:this.activeAddr.tel,phone_bk:this.activeAddr.bakTel,address:this.activeAddr.address,order_note:this.getNote(),invoice:this.getInvoice()}))))},d.prototype.fetchAddr=function(a){if(a&&!(a.length<3)){var b,c,d,e;return b=this.fetchContent(a[0]),c=this.fetchContent(a[1]),d=this.fetchContent(a[2]),e=this.fetchContent(a[3])||"",b&&c&&d?(this.$el.find(p.editAddrUserSelector).val(b),this.$el.find(p.editAddrNameSelector).val(c),this.$el.find(p.editTelSelector).val(d),this.$el.find(p.editBakTelSelector).val(e),this.activeAddr={address:c,tel:d,bakTel:e},this.updateAddressText(),!0):!1}},d.prototype.validate=function(){return this.activeAddr&&""!==this.activeAddr.address&&o.test(this.activeAddr.tel)?!0:void this.$el.find(p.addrInfoSelector).showAlertTip(p.emptyAddrTip,{outer:!0})},d.prototype.fillForm=function(){$(p.nameInputSelector).val(this.activeAddr.name),$(p.addressInputSelector).val(this.activeAddr.address),$(p.telInputSelector).val(this.activeAddr.tel),$(p.bakTelInputSelector).val(this.activeAddr.bakTel)},d.prototype.updateAddressText=function(){this.activeAddr?this.$el.find(p.addrInfoSelector).replaceWith(i(this.activeAddr)):this.$el.find(p.addrInfoSelector).text("请选择地址")},d.prototype.saveAddress=function(){var a,b,c,d,e=this,g=this.findEditingAddr(),h=this.findCurrentAddr();if(this.hideAlert(),g)return void this.updateAddress({autoClose:!0});if(this.isCreating){if(a=$.trim(this.$el.find(p.editAddrUserSelector).val()),b=$.trim(this.$el.find(p.editAddrNameSelector).val()),c=$.trim(this.$el.find(p.editTelSelector).val()),d=$.trim(this.$el.find(p.editBakTelSelector).val()),!a)return void this.$el.find(p.newAddrSelector+" "+p.editAddrUserSelector).showAlertTip(p.nameErrTip);if(!b)return void this.$el.find(p.newAddrSelector+" "+p.editAddrNameSelector).showAlertTip(p.addrErrTip);if(!o.test(c))return void this.$el.find(p.newAddrSelector+" "+p.editTelSelector).showAlertTip(p.telErrTip);if(d&&!o.test(d)&&!n.test(d))return void this.$el.find(p.newAddrSelector+" "+p.editBakTelSelector).showAlertTip(p.phoneErrTip);this.activeAddr={name:a,address:b,tel:c,bakTel:d}}else h&&(this.activeAddr={id:h.$el.data("id"),name:h.$el.find(p.rowAddrUserSelector).text(),address:h.$el.find(p.rowAddrNameSelector).text(),tel:h.$el.find(p.rowAddrTelSelector).text(),bakTel:h.$el.find(p.rowAddrBakTelSelector).text()});this.activeAddr&&(this.storeContent({checkout_name:this.activeAddr.name,checkout_addr:this.activeAddr.address,checkout_tel:this.activeAddr.tel,checkout_bak_tel:this.activeAddr.bakTel}),f({phone:this.activeAddr.tel,phone_bk:this.activeAddr.bakTel}).then(function(a){m.publish(p.onlinePaymentDiscount,a.onlinePaymentDiscount),a.newUserDiscount&&(e.$el.find(p.addrInfoSelector).showAlertTip(j(a),{noTemplate:!0,outer:!0}),$(document).one("click",function(){e.$el.find(p.newUserTipSelector).remove()}))}),m.publish(p.checkUserTopic,{phone:this.activeAddr.tel,phone_bk:this.activeAddr.bakTel,address:this.activeAddr.address,order_note:this.getNote(),invoice:this.getInvoice()}),this.setBasketPhone({phone:this.activeAddr.tel,phone_bk:this.activeAddr.bakTel})),this.updateAddressText(),this.hidePanel()},d.prototype.switchCurrentAddr=function(a){var b,c=this.findEditingAddr(),d=this.findCurrentAddr();c&&c.cancelEdit(),d&&d.cancelCurrent(),b=_.find(this.childViews,function(b){return b.id===a}),b.setupCurrent()},d.prototype.findEditingAddr=function(){return _.find(this.childViews,function(a){return a.isEditing})},d.prototype.findCurrentAddr=function(){return _.find(this.childViews,function(a){return a.isCurrent})},d.prototype.updateAddress=function(a){a=a||{};var b,c,d=this,e=this.findEditingAddr();e&&(b=e.getAddrContent(),b&&(c=e.update(b),c.then(function(){(!d.activeAddr||a.autoClose||d.activeAddr&&d.activeAddr.id===e.id)&&(d.activeAddr={id:b.id,name:b.name,address:b.address,tel:b.phone,bakTel:b.phone_bk},d.updateAddressText()),(a.autoClose||d.activeAddr&&d.activeAddr.id===e.id)&&(d.setBasketPhone({phone:b.phone,phone_bk:b.phone_bk}),m.publish(p.checkUserTopic,{phone:d.activeAddr.tel,phone_bk:d.activeAddr.bakTel,order_note:this.getNote(),invoice:this.getInvoice()})),a.autoClose&&(d.hidePanel(),f({phone:d.activeAddr.tel,phone_bk:d.activeAddr.bakTel}).then(function(a){a.newUserDiscount&&(d.$el.find(p.addrInfoSelector).showAlertTip(j(a),{noTemplate:!0,outer:!0}),$(document).one("click",function(){d.$el.find(p.newUserTipSelector).remove()}))}))})))},d.prototype.deleteAddress=function(a){var b,c,d,e=this;b=_.find(this.childViews,function(b,d){return b.id===a?(c=d,!0):void 0}),d=b.destroy(),d.then(function(){e.childViews.splice(c,1),e.activeAddr&&e.activeAddr.id===b.id&&(e.activeAddr=null,e.updateAddressText()),e.currentAddr&&e.currentAddr.id===b.id&&(e.currentAddr=null),e.childViews.length||(e.isCreating=!0,e.trigger("createChange"))})},d.prototype.setBasketPhone=function(a){m.publish(p.newUserTopic,a)},d.prototype.saveCheckoutInfo=function(){this.storeContent({checkout_name:this.activeAddr.name,checkout_addr:this.activeAddr.address,checkout_tel:this.activeAddr.tel,checkout_bak_tel:this.activeAddr.bakTel})},d.prototype.cancelEdit=function(){var a=this.findEditingAddr();a&&a.cancelEdit()},d.prototype.enterEdit=function(a){var b,c=this.findCurrentAddr();this.cancelEdit(),this.isCreating&&(this.isCreating=!1,this.trigger("createChange")),b=_.find(this.childViews,function(b){return b.id===a}),c&&b.id===c.id||this.switchCurrentAddr(b.id),b.enterEdit()},d.prototype.addChildView=function(){var a,b=this;this.$el.find(p.singleAddressSelector).each(function(c,d){a=new e(d),b.childViews.push(a)})},$.extend(e.prototype,k),e.prototype.init=function(){this.$el.hasClass("ui_current")&&(this.isCurrent=!0),this.on("editingChange",$.proxy(this.toggleEdit,this)),this.on("loadingChange",$.proxy(this.toggleLoading,this)),this.on("currentChange",$.proxy(this.toggleCurrent,this))},e.prototype.enterEdit=function(){this.isEditing=!0,this.trigger("editingChange")},e.prototype.cancelEdit=function(){this.isEditing=!1,this.trigger("editingChange")},e.prototype.setupCurrent=function(){this.isCurrent=!0,this.trigger("currentChange")},e.prototype.cancelCurrent=function(){this.isCurrent=!1,this.trigger("currentChange")},e.prototype.toggleCurrent=function(){this.isCurrent?this.$el.addClass("ui_current").find(".row_radio").prop("checked",!0):this.$el.removeClass("ui_current").find(".row_radio").prop("checked",!1)},e.prototype.toggleEdit=function(){this.isEditing?(this.$el.addClass("ui_modify").find(".edit_field").removeClass("hide").siblings(".row_label").addClass("hide"),this.$el.find(".error_tip").remove()):this.$el.removeClass("ui_modify").find(".edit_field").addClass("hide").siblings(".row_label").removeClass("hide")},e.prototype.toggleLoading=function(){this.isLoading?this.$el.find(p.editLoaderSelector).removeClass("hide").siblings(".modify_group").addClass("hide"):this.$el.find(p.editLoaderSelector).addClass("hide").siblings(".modify_group").removeClass("hide")},e.prototype.update=function(a){var b,c=this,d=a,e="http://"+ELEME.mainHost+"/address/"+a.id;return this.isLoading=!0,this.trigger("loadingChange"),this.isEditing=!1,this.trigger("editingChange"),b=_.omit(d,"id"),l.request({type:"put",url:e,data:b}).done(function(){c.updateAddrContent(d),c.isLoading=!1,c.trigger("loadingChange")}).fail(function(){})},e.prototype.updateAddrContent=function(a){this.$el.find(p.rowAddrUserSelector).text(a.name).end().find(p.rowAddrNameSelector).text(a.address).end().find(p.rowAddrTelSelector).text(a.phone).end().find(p.rowAddrBakTelSelector).text(a.phone_bk)},e.prototype.getAddrContent=function(){var a=this.$el.data("id"),b=this.$el.find(p.editAddrUserSelector),c=this.$el.find(p.editAddrNameSelector),d=this.$el.find(p.editTelSelector),e=this.$el.find(p.editBakTelSelector),f=$.trim(b.val()),g=$.trim(c.val()),h=$.trim(d.val()),i=$.trim(e.val());return""===f?void b.showAlertTip(p.nameErrTip):""===g?void c.showAlertTip(p.addrErrTip):o.test(h)?!i||n.test(i)||o.test(i)?{id:a,name:f,address:g,phone:h,phone_bk:i}:void e.showAlertTip(p.phoneErrTip):void d.showAlertTip(p.telErrTip)},e.prototype.destroy=function(){var a,b=this,c={},d=this.$el.data("id");return a="http://"+ELEME.mainHost+"/address/"+d,this.isLoading=!0,this.trigger("loadingChange"),l.request({type:"delete",url:a,data:c}).done(function(){b.$el.off().remove()}).fail(function(){})},g.AddressView=d,g.AddressItemView=e,g}(a,g,h),j=function(a){"use strict";function b(){this.$el=null,this.formInputSelector=h.formInputSelector,this.formContent=parseInt($(this.formInputSelector).val(),10),this.hasOnlinePayment=!1,this.tempDataKey="checkout_payment",this.events={},this.init()}var c,d=a,e=Eleme.Common.Evt,f=Eleme.Common.PubSub,g=Eleme.Common.Http,h={paymentWrapSelector:"#module_payment",offlinePaymentBtnSelector:"#offline_pay_btn",onlinePaymentBtnSelector:"#online_pay_btn",formInputSelector:"#value_payonline",onlinePaymentDiscountSelector:"#activity_discount",onlinePaymentDiscountValueSelector:"#activity_discount_value",paymentChangeTopic:"paymentChange",emptyPaymentTip:"请选择支付方式",onlinePaymentDiscount:"onlinePaymentDiscount"};return $.extend(b.prototype,d.prototype,e),b.prototype.init=function(){this.$el=$(h.paymentWrapSelector),this.offlineDisabled=$(h.offlinePaymentBtnSelector).hasClass("ui_disabled"),this.onlineDisabled=$(h.onlinePaymentBtnSelector).hasClass("ui_disabled"),this.subscribeOnlinePaymentDiscount(),this.onlineDisabled||(this.on("paymentChange",$.proxy(this.changeBtnStyle,this)),this.updatePayment(),this.hasOnlinePayment=!0,this.bindEvents())},b.prototype.subscribeOnlinePaymentDiscount=function(){f.subscribe(h.onlinePaymentDiscount,function(a){this.$el.find(h.onlinePaymentDiscountValueSelector).text(a),a>0?this.$el.find(h.onlinePaymentDiscountSelector).removeClass("hide"):this.$el.find(h.onlinePaymentDiscountSelector).addClass("hide")},this)},b.prototype.bindEvents=function(){var a=this;this.$el.on("click",h.offlinePaymentBtnSelector,function(){a.offlineDisabled||(a.hideAlert(),0!==a.formContent&&(a.formContent=0,a.trigger("paymentChange"),a.storeContent(a.tempDataKey,a.formContent)))}),this.$el.on("click",h.onlinePaymentBtnSelector,function(){a.onlineDisabled||(a.hideAlert(),1!==a.formContent&&a.hasOnlinePayment&&(a.formContent=1,a.trigger("paymentChange"),a.storeContent(a.tempDataKey,a.formContent)))})},b.prototype.updatePayment=function(){var a=this.fetchContent(this.tempDataKey),b=this.fetchContent("payment_preference"),c=null;if(null!==a?c=window.parseInt(a,10):null!==b&&(c=window.parseInt(b,10)),null!==c){if(0===c&&this.offlineDisabled||1===c&&this.onlineDisabled)return;this.formContent=c,this.trigger("paymentChange"),null===a&&null!==b&&this.storeContent(this.tempDataKey,this.formContent);try{localStorage.removeItem("last_payment")}catch(d){}}},b.prototype.changeBtnStyle=function(){0===this.formContent?(this.$el.find(h.offlinePaymentBtnSelector).addClass("ui_selected").siblings(h.onlinePaymentBtnSelector).removeClass("ui_selected"),f.publish(h.paymentChangeTopic,{isOnline:!1})):1===this.formContent&&(this.$el.find(h.onlinePaymentBtnSelector).addClass("ui_selected").siblings(h.offlinePaymentBtnSelector).removeClass("ui_selected"),f.publish(h.paymentChangeTopic,{isOnline:!0})),g.request({type:"put",url:"http://"+ELEME.mainHost+"/cart/is_online_paid",data:{is_online_paid:+(1===this.formContent),csrf_token:ELEME.csrfToken}}).done(function(a){f.publish("basketSyncSuccess",a)}).fail(function(){})},b.prototype.validate=function(){return 0!==this.formContent&&1!==this.formContent?(this.$el.find(h.offlinePaymentBtnSelector).showAlertTip(h.emptyPaymentTip,{outer:!0}),!1):(this.hasOnlinePayment&&this.storeContent("payment_preference",this.formContent),!0)},c=b}(a),k=function(a){"use strict";function b(){this.$el=null,this.formInputSelector=e.formInputSelector,this.formContent="",this.tempDataKey="checkout_time",this.bookOnly="please_select"===$(this.formInputSelector).val()?!0:!1,this.init()}var c,d=a,e={timeWrapSelector:"#module_time",formInputSelector:"#value_time",deliverTimeSelector:".dlv_time",timeTextSelector:".time_text",errorAlert:"请选择送餐时间",checkoutPersistentTime:6e5};return $.extend(b.prototype,d.prototype),b.prototype.init=function(){var a,b=(new Date).getTime(),c=this.fetchContent(this.tempDataKey);if(this.$el=$(e.timeWrapSelector),this.bindEvents(),c){try{c=JSON.parse(c)}catch(d){return void window.localStorage.removeItem(this.tempDataKey)}a=c.timestamp,a&&b-a<e.checkoutPersistentTime?(this.formContent=c.data,this.storeContent(this.tempDataKey,JSON.stringify({data:this.formContent,timestamp:(new Date).getTime()})),""!==this.formContent&&this.$el.find(e.timeTextSelector).text(this.formContent)):window.localStorage.removeItem(this.tempDataKey)}},b.prototype.bindEvents=function(){this.$el.on("click",e.deliverTimeSelector,$.proxy(this.selectTime,this))},b.prototype.selectTime=function(a){var b=$(a.target).text();this.formContent=b,this.storeContent(this.tempDataKey,JSON.stringify({data:this.formContent,timestamp:(new Date).getTime()})),this.hideAlert(),this.$el.find(e.timeTextSelector).text(this.formContent).trigger("click")},b.prototype.validate=function(){return this.bookOnly&&""===this.formContent?void this.$el.find(e.timeTextSelector).showAlertTip(e.errorAlert,{outer:!0}):!0},b.prototype.saveCheckoutInfo=function(){""!==this.formContent&&this.storeContent(this.tempDataKey,JSON.stringify({data:this.formContent,timestamp:(new Date).getTime()}))},c=b}(a),l=function(a,b,c,d,e,f,g){"use strict";function h(){this.$el=null,this.checkoutViews=[],this.enableAuthFeature=!1,this.code=2,this.mustVoice=!1,this.init()}var i,j=a,k=b,l=c,m=d,n=e.AddressView,o=f,p=g,q=Eleme.Common.Http,r=Eleme.Common.PubSub,s={checkoutContainerSelector:"#cart_wrap",garnishSelector:"#module_gns",invoiceSelector:"#module_inv",timeSelector:"#module_time",couponSelector:"#module_cpn",confirmOrderBtnSelector:"#confirm_order",orderFormSelector:"#checkout_form",telSelector:"#value_tel",telBkSelector:"#value_tel_bk",authSuccessTopic:"authSuccess",checkUserTopic:"checkUser",needVerifyTopic:"needVerify",geoTip:'<p class="ui-alert warning"><i class="icon-warning"></i>您上次的定位地址和这次的定位地址不同，请注意确认送餐地址是否正确。</p>'};
return h.prototype.init=function(){this.$el=$(s.checkoutContainerSelector),this.enableAuthFeature=ELEME.mcbSwitch,this.bindEvents(),this.subscribeTopic(),this.addCheckoutView(),this.checkGeo()},h.prototype.checkGeo=function(){var a=window.localStorage.getItem("last_geo"),b=$("#restaurant").data("geo");a&&a!=b&&this.$el.prepend(s.geoTip)},h.prototype.bindEvents=function(){var a=this;this.$el.on("click",s.confirmOrderBtnSelector,function(b){a.confirmOrder(b)})},h.prototype.subscribeTopic=function(){r.subscribe(s.authSuccessTopic,function(){this.hasAuthSuccess=1,this.doSubmit()},this),r.subscribe(s.checkUserTopic,function(a){this.enableAuthFeature&&this.checkUser(a)},this)},h.prototype.checkUser=function(a){var b="http://"+ELEME.mainHost+ELEME.baseUrl+"/cart/mcb/check",c=this;q.request({type:"GET",url:b,data:a}).done(function(a){2===a.code&&""===a.type&&(a.code=1),c.hasAuthSuccess=Number(a.code),c.mustVoice="Voice"===a.type?!0:!1,c.message=a.message,3===c.hasAuthSuccess&&alert("您的账户有异常，请验证手机")}).fail(function(){})},h.prototype.validateOrder=function(){var a,b,c;for(a=0,b=this.checkoutViews.length;b>a;a++){if(c=this.checkoutViews[a],!c.validate())return{status:"error"};c.saveCheckoutInfo(),c.fillForm()}return{status:"ok"}},h.prototype.confirmOrder=function(a){var b,c=this,d=this.validateOrder();return"error"===d.status?void a.preventDefault():3===this.hasAuthSuccess?alert("本次订单被系统判定为异常，无法正常下单，请联系饿了么客服"):void(1!==this.hasAuthSuccess&&this.enableAuthFeature?(b={phone:$(s.telSelector).val(),mustVoice:c.mustVoice},r.publish(s.needVerifyTopic,b)):this.doSubmit())},h.prototype.doSubmit=function(){var a=$("#restaurant").data("geo");a&&localStorage.setItem("last_geo",a),this.$el.find(s.confirmOrderBtnSelector).text("正在提交…"),this.$el.find(s.orderFormSelector).submit()},h.prototype.addCheckoutView=function(){var a,b,c,d,e,f=new o,g=new j;this.checkoutViews.push(g,e,f),this.$el.find(s.invoiceSelector).length&&(c=new m,this.checkoutViews.push(c)),this.checkoutViews[1]=new n(this),this.$el.find(s.garnishSelector).length&&(d=new l),this.$el.find(s.timeSelector).length&&(a=new p,this.checkoutViews.push(a)),this.$el.find(s.couponSelector).length&&(b=new k,this.checkoutViews.push(b))},i=h}(b,c,e,f,i,j,k),m=function(){"use strict";var a,b=function(a){{var b,c="";_.escape,Array.prototype.join}return c+='<div class="cart-summary basket_info">共',a.groups.length>1&&(c+=(null==(b=a.groups.length)?"":b)+"个篮子"),c+=(null==(b=a.quantity)?"":b)+'份美食　应付金额：<span id="total_price_basket" class="symbol-rmb cart-cost">'+(null==(b=a.total)?"":b)+"</span></div>"};return a=b}(),n=function(){"use strict";var a,b=function(a){{var b,c="",d=_.escape;Array.prototype.join}return _.each(a.groups,function(a,e){c+='<section class="cart-group cart_group" data-id="'+(null==(b=e)?"":b)+'"><h3 class="cgroup-title ui_c'+(null==(b=e+1)?"":b)+'">'+(null==(b=e+1)?"":b)+'号</h3><ul class="cgroup-list">',_.each(a,function(a){c+='<li class="cgroup-item s_food" data-id="'+(null==(b=a.id)?"":b)+'"><div class="cdish-name">'+d(a.name)+'</div><div class="cdish-price symbol-rmb">'+d(a.price)+'</div><div class="cdish-modify"><a class="cdish-action desc dec_btn">-</a><input class="cdish-qty set_num" type="text" value="'+d(a.quantity)+'" /><a class="cdish-action incr inc_btn">+</a></div><div class="cdish-total symbol-rmb">'+d(a.price*a.quantity)+'</div><div class="cdish-del"><a class="del del_btn">&times;</a></div></li>',_.each(a.garnishes,function(e){c+='<li class="cgroup-item s_food" data-id="'+(null==(b=e.id)?"":b)+'" data-parent="'+(null==(b=a.id)?"":b)+'"><div class="cdish-name"><i class="icon-rst-badge garnish"></i>&nbsp;'+d(e.name)+'</div><div class="cdish-price symbol-rmb">'+d(e.price)+'</div><div class="cdish-modify"><a class="cdish-action desc dec_btn">-</a><input class="cdish-qty set_num" type="text" value="'+d(e.quantity)+'" /><a class="cdish-action incr inc_btn">+</a></div><div class="cdish-total symbol-rmb">'+d(e.price*e.quantity)+'</div><div class="cdish-del"><a class="del del_btn">&times;</a></div></li>'})}),c+="</ul></section>"}),a.extras.length>0&&(c+='<section class="cart-group cart_group"><h3 class="cgroup-title ui_c0">其他</h3><ul class="cgroup-list">',_.each(a.extras,function(a){c+='<li class="cgroup-item s_food" data-id="'+(null==(b=a.id)?"":b)+'"><div class="cdish-name',(11==a.categoryId||12==a.categoryId)&&(c+=" highlight"),c+='">',2==a.categoryId?c+='<i class="icon-rst-badge deliver-fee"></i>&nbsp;':3==a.categoryId?c+='<i class="icon-rst-badge coupon"></i>&nbsp;':7==a.categoryId?c+='<i class="icon-rst-badge new-user-discount"></i>&nbsp;':100==a.categoryId?c+='<i class="icon-rst-badge extra-discount"></i>&nbsp;':(11==a.categoryId||12==a.categoryId)&&(c+="[限每天2单]&nbsp;"),c+=d(a.name)+'</div><div class="cdish-price symbol-rmb">'+d(a.price)+'</div><div class="cdish-modify">'+(null==(b=a.quantity)?"":b)+'</div><div class="cdish-total symbol-rmb">'+d(a.price*a.quantity)+"</div></li>"}),c+="</ul></section>"),a.abandonedExtras.length>0&&(c+='<section class="cart-group ui_abandoned cart_group"><h3 class="cgroup-title ui_abandoned">失效活动</h3><ul class="cgroup-list">',_.each(a.abandonedExtras,function(a){c+='<li class="cgroup-item " data-id="'+(null==(b=a.id)?"":b)+'"><div class="cdish-name-abandoned">'+d(a.name)+"&nbsp;("+d(a.description)+")</div></li>"}),c+="</ul></section>"),c};return a=b}(),o=function(a,b){"use strict";function c(){this.$el=null,this.teardownErrorTip=null,this.init()}function d(a){var b=a.data("id"),c=a.data("parent")||0,d=a.closest(j.groupRowSelector).data("id")||0;return[d,c,b]}var e,f=a,g=b,h=Eleme.Common.Http,i=Eleme.Common.PubSub,j={basketWrapSelector:"#module_basket",foodRowSelector:".s_food",groupRowSelector:".cart_group",decBtnSelector:".dec_btn",incBtnSelector:".inc_btn",delBtnSelector:".del_btn",setNumSelector:".set_num",basketGroupSelector:".cart_group",basketInfoSelector:".basket_info",basketPriceSelector:"#total_price_basket",cartWrapSelector:"#cart_wrap",errTipSelector:"#cart_err_tip",confirmOrderBtnSelector:"#confirm_order",basketSyncSuccessTopic:"basketSyncSuccess",handleCouponTopic:"handleCoupon",newUserTopic:"newUser"};return c.prototype.init=function(){this.$el=$(j.basketWrapSelector),this.bindEvents(),this.subscribeTopic(),$(j.errTipSelector).length>0&&(this.teardownErrorTip=function(){$(j.errTipSelector).remove(),$(j.confirmOrderBtnSelector).attr("disabled",!1).removeClass("ui_disabled").addClass("ui_submit").text("确认下单"),this.teardownErrorTip=null})},c.prototype.bindEvents=function(){var a=this;this.$el.on("click",j.decBtnSelector,function(b){var c=$(b.target),e=c.closest(j.foodRowSelector),f=d(e);a.handleFood(f,{type:"dec"})}),this.$el.on("click",j.incBtnSelector,function(b){var c=$(b.target),e=c.closest(j.foodRowSelector),f=d(e);a.handleFood(f,{type:"inc"})}),this.$el.on("click",j.delBtnSelector,function(b){var c=$(b.target),e=c.closest(j.foodRowSelector),f=d(e);a.handleFood(f,{type:"del"})}),this.$el.on("change",j.setNumSelector,function(b){var c=$(b.target),e=c.val(),f=c.closest(j.foodRowSelector),g=d(f);a.handleFood(g,{type:"set",payload:{num:e}})})},c.prototype.subscribeTopic=function(){i.subscribe(j.basketSyncSuccessTopic,this.parseBasketData,this),i.subscribe(j.handleCouponTopic,this.syncBasket,this),i.subscribe(j.newUserTopic,this.setBasketPhone,this)},c.prototype.parseBasketData=function(a){return 0===a.quantity?void window.location.reload():(this.teardownErrorTip&&this.teardownErrorTip(),this.checkDeliver(a)&&(this.showAlert(a),this.teardownErrorTip=function(){$(j.errTipSelector).remove(),$(j.confirmOrderBtnSelector).attr("disabled",!1).removeClass("ui_disabled").addClass("ui_submit").text("确认下单"),this.teardownErrorTip=null},$(j.confirmOrderBtnSelector).attr("disabled",!0).removeClass("ui_submit").addClass("ui_disabled").text("未满起送价")),this.render(a),void this.updateBasketInfo(a))},c.prototype.render=function(a){var b=g(a);this.$el.find(j.basketGroupSelector).remove(),this.$el.find("header").after(b)},c.prototype.updateBasketInfo=function(a){this.$el.find(j.basketInfoSelector).replaceWith(f(a))},c.prototype.showAlert=function(a){var b='<p id="cart_err_tip" class="ui-alert warning"><i class="icon-warning"></i>未满餐厅起送价('+a.restaurantDeliverAmount+"元)，请继续选购美食。</p>";$(j.cartWrapSelector).prepend(b)},c.prototype.checkDeliver=function(a){return a.deliverAmount<a.restaurantDeliverAmount},c.prototype.handleFood=function(a,b){var c,d,e={del:{url:"/cart/delete/"},dec:{url:"/cart/decrease/",payload:{num:-1}},inc:{url:"/cart/add/",payload:{num:1}},set:{url:"/cart/set/"}};c="http://"+ELEME.mainHost+e[b.type].url+a.join("/"),d=b.payload||e[b.type].payload||{},h.request({url:c,type:"get",cache:!1,data:d}).done(function(a){i.publish(j.basketSyncSuccessTopic,a)}).fail(function(a){i.publish(j.basketSyncFailurTopic,a)})},c.prototype.setBasketPhone=function(a){var b=a,c="http://"+ELEME.mainHost+"/cart/phone";h.request({type:"put",url:c,data:b}).done(function(a){i.publish(j.basketSyncSuccessTopic,a)}).fail(function(){})},c.prototype.syncBasket=function(){var a="http://"+ELEME.mainHost+"/cart";h.request({type:"get",url:a,cache:!1}).done(function(a){i.publish(j.basketSyncSuccessTopic,a)}).fail(function(){})},e=c}(m,n),p=function(){"use strict";function a(){this.init()}var b,c=Eleme.Common.Http,d={SELECTOR:{VMOBILE_MODAL:"#modal_mobileVerify",VCODE_INPUT:"#vcode_input",VCODE_SEND_BTN:"#vcode_send",VCODE_CONFIRM_BTN:"#vcode_confirm"},URL:{SEND_VCODE:ELEME.baseUrl+"/terminalCode/send",VALIDATE_VCODE:ELEME.baseUrl+"/terminalCode/validate"},MESSAGE:{VCODE_REG_ERROR:"请填写6位验证码",VCODE_ERROR:"验证码错误"},DISABLED_CLASSNAME:"ui_disabled",VCODE_REG:/^\d{6}$/};return a.prototype.init=function(){this.isVerifiedKey=null,this.$app=$(d.SELECTOR.VMOBILE_MODAL),this.$input=$(d.SELECTOR.VCODE_INPUT),this.$sendBtn=$(d.SELECTOR.VCODE_SEND_BTN),this.$confirmBtn=$(d.SELECTOR.VCODE_CONFIRM_BTN),this.bindEvents(),this.showModal(),this.checkCountDown()},a.prototype.bindEvents=function(){var a=this;this.$sendBtn.on("click",$.proxy(this.sendVcode,this)),this.$confirmBtn.on("click",$.proxy(this.validateVcode,this)),this.$input.on("focus",function(){$(this).removeAlertTip()}).on("keypress",function(b){"13"==b.which&&a.$confirmBtn.trigger("click")})},a.prototype.showModal=function(){this.$app.modal({backdrop:"static",keyboard:!1})},a.prototype.hideModal=function(){this.$app.modal("hide")},a.prototype.checkCountDown=function(){var a=this.$sendBtn.data("counted")?this.$sendBtn.data("counted"):0;a>0&&60>a&&(this.$sendBtn.addClass(d.DISABLED_CLASSNAME),this.setCountdown(this.$sendBtn,60-a))},a.prototype.setCountdown=function(a,b){a.text(b+"秒后重新获取");var c=setInterval(function(){return b-=1,0===b?(clearInterval(c),void a.text("发送短信验证码").removeClass(d.DISABLED_CLASSNAME)):void a.text(b+"秒后重新获取")},1e3)},a.prototype.sendVcode=function(){if(!this.$sendBtn.is("."+d.DISABLED_CLASSNAME)){var a=this,b={terminal_type:"0"};this.$sendBtn.removeAlertTip().addClass(d.DISABLED_CLASSNAME),c.request({type:"POST",url:d.URL.SEND_VCODE,data:b}).done(function(b){200===b.code&&a.setCountdown(a.$sendBtn,60)}).fail(function(b){b.msg&&a.$sendBtn.showAlertTip(b.msg),a.$sendBtn.removeClass(d.DISABLED_CLASSNAME)})}},a.prototype.validateVcode=function(){var a,b=this,e=$(d.SELECTOR.VCODE_INPUT).val();this.$input.removeAlertTip(),d.VCODE_REG.test(e)?(a={terminal_type:0,validate_code:e},c.request({type:"POST",url:d.URL.VALIDATE_VCODE,data:a}).done(function(a){a.success?(b.hideModal(),localStorage.setItem(b.isVerifiedKey,"true")):b.$input.showAlertTip(d.MESSAGE.VCODE_ERROR)}).fail(function(a){b.$input.showAlertTip(a.msg)})):this.$input.showAlertTip(d.MESSAGE.VCODE_REG_ERROR)},b=a}(),q=function(a){"use strict";function b(){this.$el=null,this.isAuthed=!1,this.sendSMSDisabled=!1,this.sendVoiceDisabled=!1,this.phoneBinded=!1,this.requesting=!1,this.phone=null,this.mustVoice=null,this.init()}var c,d=Eleme.Common.Http,e=Eleme.Common.PubSub,f={authModalSelector:"#modal_userAuth",authPhoneSelector:".auth_tel",validateBtnSelector:".vcode_confirm",codeInputSelector:".vcode_input",sendBtnSelector:".vcode_send",smsCountdownSelector:".vcode_countdown",voiceCountdownSelector:".voice_countdown",voiceBtnSelector:".voice_btn",bindPhoneSelector:".bindphone_cb",bindWrapSelector:".bind_wrap",voiceTipSelector:".voice_tip",checkoutAuthTitleSelector:".checkout_auth_title",needVerifyTopic:"needVerify",authSuccessTopic:"authSuccess"};return b.prototype.init=function(){this.$el=$(f.authModalSelector),this.isAuthed=ELEME.authed,this.phoneBinded=ELEME.phoneBinded,this.bindEvents(),this.subscribeTopic()},b.prototype.bindEvents=function(){var a=this;this.$el.on("click",function(a){"modal_userAuth"===a.target.id&&$(this).modal("hide")}),this.$el.on("click",f.validateBtnSelector,function(){$(this).hasClass("ui_disabled")||a.validateCode()}),this.$el.on("keyup",f.codeInputSelector,function(b){$(this).hasClass("ui_disabled")||13!==b.which||a.validateCode()}),this.$el.on("click",f.sendBtnSelector,function(){$(this).hasClass("ui_disabled")||a.requesting||a.sendCode("sms")}),this.$el.on("click",f.voiceBtnSelector,function(){$(this).hasClass("ui_disabled")||a.requesting||a.sendCode("voice")})},b.prototype.subscribeTopic=function(){e.subscribe(f.needVerifyTopic,function(a){if(this.showModal(),this.phone=a.phone,this.mustVoice=a.mustVoice,a.mustVoice){var b=this.$el.find(f.codeInputSelector),c=this.$el.find(f.sendBtnSelector),d=this.$el.find(f.checkoutAuthTitleSelector);b.attr("placeholder","请输入语音验证码"),c.html('重发语音<span class="countdown vcode_countdown ui_hide"></span>'),d.html("语音"+d.html())}this.sendCode("sms"),this.$el.find(f.authPhoneSelector).text(a.phone)},this)},b.prototype.showModal=function(){this.$el.modal({backdrop:"static",keyboard:!1})},b.prototype.validateCode=function(){var a=this,b=this.$el.find(f.validateBtnSelector),c=this.$el.find(f.codeInputSelector),d=$.trim(c.val());return""===d?void c.showAlertTip("请填写验证码").one("blur",function(){$(this).removeAlertTip()}).focus():(b.addClass("ui_disabled").text("提交中..."),void this._validateCode(d).done(function(b){b.success&&(a.$el.modal("hide"),e.publish(f.authSuccessTopic))}).fail(function(c){b.removeClass("ui_disabled").text("提交验证"),a.showError(c)}))},b.prototype._validateCode=function(a){var b,c="http://"+ELEME.mainHost+ELEME.baseUrl+"/terminalCode/validateMCBCode",e=this.$el.find(f.bindPhoneSelector);return b={code:a,phone:this.phone},!this.phoneBinded&&this.isAuthed&&(b.bindphone=e.prop("checked")?1:0),d.request({type:"POST",url:c,data:b})},b.prototype.sendCode=function(a){a=a||"sms";var b,c=null,d=this;c=this.mustVoice?"voice":a,b={type:c,phone:this.phone},this.requesting=!0,this._sendCode(b).then(function(b){b.success&&("sms"===a?(d.sendSMSDisabled=!0,d.updateSendBtn(a),d.smsCountdown()):"voice"===a&&(d.sendVoiceDisabled=!0,d.$el.find(f.voiceTipSelector).removeClass("ui_hide"),d.updateVoiceBtn(),d.voiceCountdown())),d.requesting=!1})},b.prototype._sendCode=function(a){var b="http://"+ELEME.mainHost+ELEME.baseUrl+"/terminalCode/sendMCBCode";return d.request({type:"POST",url:b,data:a})},b.prototype.updateSendBtn=function(){this.sendSMSDisabled?this.$el.find(f.sendBtnSelector).addClass("ui_disabled").children(f.smsCountdownSelector).removeClass("ui_hide"):this.$el.find(f.sendBtnSelector).removeClass("ui_disabled").children(f.smsCountdownSelector).addClass("ui_hide")},b.prototype.updateVoiceBtn=function(){this.sendVoiceDisabled?this.$el.find(f.voiceBtnSelector).addClass("ui_disabled").children(f.resendVoiceSelector).removeClass("ui_hide"):this.$el.find(f.voiceBtnSelector).removeClass("ui_disabled").children(f.resendVoiceSelector).addClass("ui_hide")},b.prototype.showError=function(){var a=this.$el.find(f.codeInputSelector);a.showAlertTip("验证码错误").one("blur",function(){$(this).removeAlertTip()}).focus()},b.prototype.smsCountdown=function(){function a(){c>0?(c-=1,e.text(c)):(window.clearInterval(b),d.sendSMSDisabled=!1,d.updateSendBtn())}var b,c=60,d=this,e=this.$el.find(f.smsCountdownSelector);a(),b=window.setInterval(a,1e3)},b.prototype.voiceCountdown=function(){function a(){c>0?(c-=1,e.text(c)):(window.clearInterval(b),d.sendVoiceDisabled=!1,d.updateVoiceBtn())}var b,c=60,d=this,e=this.$el.find(f.voiceCountdownSelector);a(),b=window.setInterval(a,1e3)},c=b}(p);!function(a,b,c){"use strict";{var d=a,e=b,f=c;new d,new e,new f}}(l,o,q)}();