<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.cat.rufull.domain.mapper.evaluation.EvaluationMapper">

    <resultMap id="Item" type="com.cat.rufull.domain.model.LineItem">
        <id column="id" property="id"/>
        <result column="product_name" property="productName"/>
        <result column="price" property="price"/>
        <result column="quantity" property="quantity"/>
        <result column="order_id" property="orderId"/>
        <result column="product_id" property="productId"/>
    </resultMap>
    
    <resultMap id="productEvalList" type="com.cat.rufull.domain.model.ProductEvaluation">
        <id column="productEvalId" property="id"/>
        <result column="productEvalScore" property="score"/>
        <result column="productEvalComment" property="comment"/>
        
        <association property="item" resultMap="Item"/>
    </resultMap>

    <resultMap id="EvaluationDetail" type="com.cat.rufull.domain.model.OrderEvaluation">
        <id column="id" property="id"/>
        <result column="score" property="score"/>
        <result column="comment" property="comment"/>
        <result column="reply" property="reply"/>
        <result column="eval_time" property="evalTime"/>
        <result column="shop_id" property="shopId"/>

        <collection property="productEvaluations" resultMap="productEvalList">

        </collection>
    </resultMap>

    <!-- 添加订单评价-->
    <insert id="addOrderEvaluation" parameterType="OrderEvaluation" >
    insert into order_evaluation (id, score, comment,reply, eval_time,order_id, shop_id)
    values (#{id,jdbcType=INTEGER}, #{score,jdbcType=INTEGER}, #{comment,jdbcType=VARCHAR},
      #{reply,jdbcType=VARCHAR}, #{evalTime,jdbcType=TIMESTAMP},
      #{orderId,jdbcType=INTEGER}, #{shopId,jdbcType=INTEGER}
      )
  </insert>

    <!-- 根据商店id查询评价 -->
    <select id="findEvalByShopId" parameterType="Integer" resultMap="EvaluationDetail">
        SELECT oe.* ,
        pe.id AS productEvalId,
        pe.score AS productEvalScore,
        pe.comment AS productEvalComment,
        li.*
        FROM order_evaluation oe, product_evaluation pe, line_item li
        WHERE shop_id = #{id}
        AND oe.order_id = pe.order_eval_id
	    AND pe.item_id = li.id
    </select>
</mapper>